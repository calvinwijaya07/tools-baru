<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Bazi (Chart Master Lengkap)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .hanzi { font-family: 'Noto Sans SC', sans-serif; font-size: 2.5rem; line-height: 1; font-weight: 700; color: #1f2937; }
        
        .horizontal-scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        
        .day-master-pillar { background-color: #f0fdf4; border-color: #22c55e; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); }
        
        .element-color-Wood, .bar-Wood { background-color: #a7f3d0; color: #047857; }
        .element-color-Fire, .bar-Fire { background-color: #fecaca; color: #b91c1c; }
        .element-color-Earth, .bar-Earth { background-color: #fed7aa; color: #9a3412; }
        .element-color-Metal, .bar-Metal { background-color: #e5e7eb; color: #374151; }
        .element-color-Water, .bar-Water { background-color: #bfdbfe; color: #1d4ed8; }

        .luck-pillar-card.active { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .luck-pillar-card.current { border-color: #16a34a; box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); background-color: #f0fdf4; }
        .liunian-card.active { border-color: #1d4ed8; background-color: #dbeafe; transform: translateY(-4px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .liunian-card.current { border-color: #f97316; box-shadow: 0 0 15px rgba(249, 115, 22, 0.6); background-color: #fff7ed; }
        
        .card-hidden-stems { display: flex; justify-content: space-around; align-items: center; padding-top: 8px; margin-top: 8px; border-top: 1px solid #e5e7eb; }
        .card-hidden-stems.compact { padding-top: 6px; margin-top: 6px; }

        .strength-bar-bg { background-color: #f3f4f6; }
        .strength-bar { transition: width 0.8s ease-in-out; }

        .kong-wang-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #4b5563;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 9999px;
            line-height: 1;
            z-index: 10;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Kalkulator Bazi (八字) Master</h1>
            <p class="text-gray-500 mt-2">Chart Lengkap dengan Analisis Kekuatan Elemen & 10 Gods</p>
        </header>

        <!-- Kalkulator Input Section -->
        <section class="bg-white shadow-xl rounded-xl max-w-4xl mx-auto p-6 border border-gray-200 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Masukkan Data Kelahiran</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div class="md:col-span-2">
                    <label class="block mb-2 text-sm font-medium text-gray-700">Tanggal Lahir</label>
                    <div class="flex items-center gap-2">
                        <select id="birth-day" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                        <select id="birth-month" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                        <select id="birth-year" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                    </div>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-700">Gender</label>
                    <select id="gender" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="male">Pria</option>
                        <option value="female">Wanita</option>
                    </select>
                </div>
                <div class="md:col-span-3">
                    <label class="block mb-2 text-sm font-medium text-gray-700">Jam Lahir (24 Jam)</label>
                    <div class="flex items-center gap-2">
                        <select id="birth-hour" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 disabled:opacity-50 disabled:bg-gray-200"></select>
                        <span class="font-bold text-gray-600">:</span>
                        <select id="birth-minute" class="w-full bg-white border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 disabled:opacity-50 disabled:bg-gray-200"></select>
                        <div class="flex items-center ml-4">
                            <input id="unknown-birth-hour-checkbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="unknown-birth-hour-checkbox" class="ml-2 text-sm font-medium text-gray-700 whitespace-nowrap">Saya tidak tahu jam lahir</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-4">
                <button id="calculate-bazi-btn" class="w-full px-5 py-3 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 transition-all">
                    <span>Tampilkan Chart Bazi & Analisis</span>
                </button>
                <button id="reset-all-btn" class="w-full sm:w-auto px-5 py-3 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 focus:ring-4 focus:outline-none focus:ring-gray-300 transition-all">
                    Reset
                </button>
            </div>
        </section>

        <!-- Container untuk semua hasil -->
        <div id="results-container" class="max-w-7xl mx-auto space-y-8">
            <section id="bazi-chart-result"></section>
            <section id="dm-analysis-result"></section>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <section id="element-strength-analysis"></section>
                <section id="gods-strength-analysis"></section>
            </div>
            <section id="luck-pillar-result"></section>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA & DATABASE (TIDAK DIUBAH) ---
        const heavenlyStemsData = [ { char: '甲', pinyin: 'Jia', element: 'Wood', polarity: 'Yang' }, { char: '乙', pinyin: 'Yi', element: 'Wood', polarity: 'Yin' }, { char: '丙', pinyin: 'Bing', element: 'Fire', polarity: 'Yang' }, { char: '丁', pinyin: 'Ding', element: 'Fire', polarity: 'Yin' }, { char: '戊', pinyin: 'Wu', element: 'Earth', polarity: 'Yang' }, { char: '己', pinyin: 'Ji', element: 'Earth', polarity: 'Yin' }, { char: '庚', pinyin: 'Geng', element: 'Metal', polarity: 'Yang' }, { char: '辛', pinyin: 'Xin', element: 'Metal', polarity: 'Yin' }, { char: '壬', pinyin: 'Ren', element: 'Water', polarity: 'Yang' }, { char: '癸', pinyin: 'Gui', element: 'Water', polarity: 'Yin' } ];
        const earthlyBranchesData = [ { char: '子', pinyin: 'Zi', element: 'Water', polarity: 'Yang', shio: 'Tikus', shio_char: '鼠', hidden: { mainQi: 9, otherQi: [] } }, { char: '丑', pinyin: 'Chou', element: 'Earth', polarity: 'Yin', shio: 'Kerbau', shio_char: '牛', hidden: { mainQi: 5, otherQi: [9, 7] } }, { char: '寅', pinyin: 'Yin', element: 'Wood', polarity: 'Yang', shio: 'Macan', shio_char: '虎', hidden: { mainQi: 0, otherQi: [2, 4] } }, { char: '卯', pinyin: 'Mao', element: 'Wood', polarity: 'Yin', shio: 'Kelinci', shio_char: '兔', hidden: { mainQi: 1, otherQi: [] } }, { char: '辰', pinyin: 'Chen', element: 'Earth', polarity: 'Yang', shio: 'Naga', shio_char: '龍', hidden: { mainQi: 4, otherQi: [1, 9] } }, { char: '巳', pinyin: 'Si', element: 'Fire', polarity: 'Yin', shio: 'Ular', shio_char: '蛇', hidden: { mainQi: 2, otherQi: [6, 4] } }, { char: '午', pinyin: 'Wu', element: 'Fire', polarity: 'Yang', shio: 'Kuda', shio_char: '馬', hidden: { mainQi: 3, otherQi: [5] } }, { char: '未', pinyin: 'Wei', element: 'Earth', polarity: 'Yin', shio: 'Kambing', shio_char: '羊', hidden: { mainQi: 5, otherQi: [3, 1] } }, { char: '申', pinyin: 'Shen', element: 'Metal', polarity: 'Yang', shio: 'Monyet', shio_char: '猴', hidden: { mainQi: 6, otherQi: [8, 4] } }, { char: '酉', pinyin: 'You', element: 'Metal', polarity: 'Yin', shio: 'Ayam', shio_char: '雞', hidden: { mainQi: 7, otherQi: [] } }, { char: '戌', pinyin: 'Xu', element: 'Earth', polarity: 'Yang', shio: 'Anjing', shio_char: '狗', hidden: { mainQi: 4, otherQi: [7, 3] } }, { char: '亥', pinyin: 'Hai', element: 'Water', polarity: 'Yin', shio: 'Babi', shio_char: '豬', hidden: { mainQi: 8, otherQi: [0] } } ];
        const tenGods = { F: { name: 'Friend', cn: '比肩', abbr: 'F' }, RW: { name: 'Rob Wealth', cn: '劫財', abbr: 'RW' }, EG: { name: 'Eating God', cn: '食神', abbr: 'EG' }, HO: { name: 'Hurting Officer', cn: '傷官', abbr: 'HO' }, DW: { name: 'Direct Wealth', cn: '正財', abbr: 'DW' }, IW: { name: 'Indirect Wealth', cn: '偏財', abbr: 'IW' }, DO: { name: 'Direct Officer', cn: '正官', abbr: 'DO' }, '7K': { name: '7 Killings', cn: '七殺', abbr: '7K' }, DR: { name: 'Direct Resource', cn: '正印', abbr: 'DR' }, IR: { name: 'Indirect Resource', cn: '偏印', abbr: 'IR' } };
        const elementCycle = ['Wood', 'Fire', 'Earth', 'Metal', 'Water'];
        const solarMonthStartDates = [6, 5, 6, 5, 6, 6, 7, 8, 8, 9, 8, 7];
        const dom = { birthDayInput: document.getElementById('birth-day'), birthMonthInput: document.getElementById('birth-month'), birthYearInput: document.getElementById('birth-year'), birthHourInput: document.getElementById('birth-hour'), birthMinuteInput: document.getElementById('birth-minute'), genderInput: document.getElementById('gender'), calculateBtn: document.getElementById('calculate-bazi-btn'), resetAllBtn: document.getElementById('reset-all-btn'), resultDiv: document.getElementById('bazi-chart-result'), luckPillarResult: document.getElementById('luck-pillar-result'), elementAnalysisDiv: document.getElementById('element-strength-analysis'), dmAnalysisDiv: document.getElementById('dm-analysis-result'), godsAnalysisDiv: document.getElementById('gods-strength-analysis'), unknownBirthHourCheckbox: document.getElementById('unknown-birth-hour-checkbox') };
        
        let natalChartPillars = [];
        let natalChartScores = null;
        let natalDayMasterAnalysis = null;
        let natalGodsScores = null;
        let activeKongWang = [];
        
        // --- LOGIKA PERHITUNGAN INTI ---
        function calculateBaziChart() {
            dom.resultDiv.innerHTML = ""; dom.luckPillarResult.innerHTML = ""; dom.elementAnalysisDiv.innerHTML = ""; dom.dmAnalysisDiv.innerHTML = ""; dom.godsAnalysisDiv.innerHTML = "";
            const year = parseInt(dom.birthYearInput.value), month = parseInt(dom.birthMonthInput.value), day = parseInt(dom.birthDayInput.value), isHourUnknown = dom.unknownBirthHourCheckbox.checked;
            const baziYear = (month < 1 || 1 === month && day < 5) ? year - 1 : year, yearStemIndex = (baziYear - 1924) % 10, yearBranchIndex = (baziYear - 1924) % 12;
            let baziGregorianMonth = month;
            const triggerDay = solarMonthStartDates[month];
            if (isHourUnknown) { if (day < triggerDay) baziGregorianMonth = (month - 1 + 12) % 12; }
            else { const hour = parseInt(dom.birthHourInput.value), minute = parseInt(dom.birthMinuteInput.value); if (day < triggerDay || day === triggerDay && (hour < 9 || 9 === hour && minute < 22)) baziGregorianMonth = (month - 1 + 12) % 12; }
            const gregorianToSolarOrderMap = [11,0,1,2,3,4,5,6,7,8,9,10], gregorianToBranchIndexMap = [1,2,3,4,5,6,7,8,9,10,11,0];
            let firstMonthStemIndex;
            switch (yearStemIndex) { case 0: case 5: firstMonthStemIndex = 2; break; case 1: case 6: firstMonthStemIndex = 4; break; case 2: case 7: firstMonthStemIndex = 6; break; case 3: case 8: firstMonthStemIndex = 8; break; case 4: case 9: firstMonthStemIndex = 0; }
            const solarMonthOrder = gregorianToSolarOrderMap[baziGregorianMonth], monthStemIndex = (firstMonthStemIndex + solarMonthOrder) % 10, monthBranchIndex = gregorianToBranchIndexMap[baziGregorianMonth];
            const refDate = new Date("1924-01-01T00:00:00Z"), targetDate = new Date(Date.UTC(year, month, day)), timeDiff = targetDate.getTime() - refDate.getTime(), dayDiff = Math.floor(timeDiff / 864e5), dayGanzhiIndex = (dayDiff + 15) % 60, dayStemIndex = dayGanzhiIndex % 10, dayBranchIndex = dayGanzhiIndex % 12;
            let hourStemIndex = null, hourBranchIndex = null;
            if (!isHourUnknown) { const hour = parseInt(dom.birthHourInput.value), dayStemForHourCalc = hour >= 23 ? (dayStemIndex + 1) % 10 : dayStemIndex, ziHourStemIndex = [0,2,4,6,8,0,2,4,6,8][dayStemForHourCalc]; hourBranchIndex = Math.floor((hour + 1) / 2) % 12; hourStemIndex = (ziHourStemIndex + hourBranchIndex) % 10; }
            const pillars = [ { title: "HOUR", title_cn: "時", stemIndex: hourStemIndex, branchIndex: hourBranchIndex }, { title: "DAY", title_cn: "日", stemIndex: dayStemIndex, branchIndex: dayBranchIndex }, { title: "MONTH", title_cn: "月", stemIndex: monthStemIndex, branchIndex: monthBranchIndex }, { title: "YEAR", title_cn: "年", stemIndex: yearStemIndex, branchIndex: yearBranchIndex } ];
            const dayMasterIndex = dayStemIndex;
            const processedPillars = pillars.map(p => { if (null === p.stemIndex) return { ...p, isUnknown: true, stem: { char: "?", pinyin: "Unknown" }, branch: { char: "?", pinyin: "Unknown" }, hidden: { main: null, others: [] }, stemIndex: null, branchIndex: null }; const stem = heavenlyStemsData[p.stemIndex], branch = earthlyBranchesData[p.branchIndex], hidden = branch.hidden, mainHidden = null !== hidden.mainQi ? heavenlyStemsData[hidden.mainQi] : null, otherHidden = hidden.otherQi.map(i => heavenlyStemsData[i]); return { ...p, isUnknown: false, stem: { ...stem, god: get10God(dayMasterIndex, p.stemIndex) || { name: "Day Master", cn: "日主", abbr: "DM" } }, branch: branch, hidden: { main: mainHidden ? { ...mainHidden, god: get10God(dayMasterIndex, hidden.mainQi) } : null, others: otherHidden.map((h, i) => ({ ...h, god: get10God(dayMasterIndex, hidden.otherQi[i]) })) }, stemIndex: p.stemIndex, branchIndex: p.branchIndex }; });
            
            activeKongWang = calculateKongWang(dayGanzhiIndex);
            displayBaziChart(processedPillars, activeKongWang);
            return { processedPillars: processedPillars };
        }
        function get10God(dayMasterIndex, targetStemIndex){const dayMaster = heavenlyStemsData[dayMasterIndex], targetStem = heavenlyStemsData[targetStemIndex]; if(dayMaster.char === targetStem.char) return tenGods.F; const dmElementIndex = elementCycle.indexOf(dayMaster.element), targetElementIndex = elementCycle.indexOf(targetStem.element); if(dayMaster.element === targetStem.element) return tenGods.RW; const cycleDiff = (targetElementIndex - dmElementIndex + 5) % 5; switch(cycleDiff){ case 1: return dayMaster.polarity === targetStem.polarity ? tenGods.EG : tenGods.HO; case 2: return dayMaster.polarity === targetStem.polarity ? tenGods.IW : tenGods.DW; case 3: return dayMaster.polarity === targetStem.polarity ? tenGods['7K'] : tenGods.DO; case 4: return dayMaster.polarity === targetStem.polarity ? tenGods.IR : tenGods.DR; default: return null; }}
        function calculateLuckPillars(natalPillars, gender) { const yearStemPolarity = natalPillars[3].stem.polarity; const monthStemIndex = natalPillars[2].stemIndex; const monthBranchIndex = natalPillars[2].branchIndex; let direction = (gender === 'male' && yearStemPolarity === 'Yin') || (gender === 'female' && yearStemPolarity === 'Yang') ? -1 : 1; const luckPillars = []; for (let i = 1; i <= 10; i++) { const lpStemIndex = (monthStemIndex + i * direction + 100) % 10; const lpBranchIndex = (monthBranchIndex + i * direction + 120) % 12; const startAge = (i - 1) * 10 + 2; luckPillars.push({ stemIndex: lpStemIndex, branchIndex: lpBranchIndex, startAge: startAge, endAge: startAge + 9 }); } return { pillars: luckPillars }; }
        
        function calculateKongWang(dayGanzhiIndex) {
            const decade = Math.floor(dayGanzhiIndex / 10);
            const voidMap = [ ['Xu', 'Hai'], ['Shen', 'You'], ['Wu', 'Wei'], ['Chen', 'Si'], ['Yin', 'Mao'], ['Zi', 'Chou'] ];
            return voidMap[decade];
        }

        function calculateElementStrength(basePillars, additionalPillars = []) {
            const allPillars = [...basePillars, ...additionalPillars];
            const scores = { Wood: 0, Fire: 0, Earth: 0, Metal: 0, Water: 0 };
            const knownPillars = allPillars.filter(p => !p.isUnknown);
            if (knownPillars.length < 3) return scores;

            const seasonalStrengthMap = {
                'Yin': { Wood: 2.0, Fire: 1.5, Water: 1.2, Earth: 0.8, Metal: 0.6 }, 'Mao': { Wood: 2.2, Fire: 1.6, Water: 1.1, Earth: 0.7, Metal: 0.5 },
                'Chen': { Earth: 2.0, Wood: 1.4, Fire: 1.2, Metal: 0.8, Water: 0.7 }, 'Si': { Fire: 2.0, Earth: 1.5, Wood: 1.2, Metal: 0.8, Water: 0.6 },
                'Wu': { Fire: 2.2, Earth: 1.6, Wood: 1.1, Metal: 0.7, Water: 0.5 }, 'Wei': { Earth: 2.0, Fire: 1.4, Metal: 1.2, Wood: 0.8, Water: 0.7 },
                'Shen': { Metal: 2.0, Water: 1.5, Earth: 1.2, Fire: 0.8, Wood: 0.6 }, 'You': { Metal: 2.2, Water: 1.6, Earth: 1.1, Fire: 0.7, Wood: 0.5 },
                'Xu': { Earth: 2.0, Metal: 1.4, Fire: 1.2, Water: 0.8, Wood: 0.7 }, 'Hai': { Water: 2.0, Wood: 1.5, Metal: 1.2, Fire: 0.8, Earth: 0.6 },
                'Zi': { Water: 2.2, Wood: 1.6, Metal: 1.1, Fire: 0.7, Earth: 0.5 }, 'Chou': { Earth: 2.0, Water: 1.4, Metal: 1.2, Wood: 0.8, Fire: 0.7 }
            };

            const monthBranchPinyin = basePillars[2].branch.pinyin;
            const multiplier = seasonalStrengthMap[monthBranchPinyin];

            knownPillars.forEach(p => {
                scores[p.stem.element] += 11 * multiplier[p.stem.element];
                scores[p.branch.element] += 24 * multiplier[p.branch.element];
                if (p.hidden.main) scores[p.hidden.main.element] += 8 * multiplier[p.hidden.main.element];
                p.hidden.others.forEach(h => scores[h.element] += 4 * multiplier[h.element]);
            });

            const allStems = knownPillars.map(p => p.stem);
            allStems.forEach((stem) => {
                let isRooted = false;
                knownPillars.forEach(p => {
                    if (p.branch.element === stem.element) isRooted = true;
                    if (p.hidden.main && p.hidden.main.element === stem.element) isRooted = true;
                    p.hidden.others.forEach(h => { if (h.element === stem.element) isRooted = true; });
                });
                if (isRooted) {
                    scores[stem.element] += 16;
                    const stemPillar = knownPillars.find(p => p.stem.char === stem.char);
                    if (stemPillar && (stemPillar.title === 'DAY' || stemPillar.title === 'MONTH')) {
                        scores[stem.element] += 11;
                    }
                }
            });

            const branches = knownPillars.map(p => p.branch.pinyin);
            const threeHarmony = { Water: ['Shen', 'Zi', 'Chen'], Fire: ['Yin', 'Wu', 'Xu'], Metal: ['Si', 'You', 'Chou'], Wood: ['Hai', 'Mao', 'Wei'] };
            for (const [element, combo] of Object.entries(threeHarmony)) {
                if (combo.every(b => branches.includes(b))) scores[element] += 30;
                else if ((branches.includes(combo[0]) && branches.includes(combo[1])) || (branches.includes(combo[1]) && branches.includes(combo[2]))) {
                    scores[element] += 15;
                }
            }
            const sixHarmony = { 'Zi-Chou': 'Earth', 'Yin-Hai': 'Wood', 'Mao-Xu': 'Fire', 'Chen-You': 'Metal', 'Si-Shen': 'Water', 'Wu-Wei': 'Fire' };
            for (const [pair, element] of Object.entries(sixHarmony)) {
                const [b1, b2] = pair.split('-');
                if (branches.includes(b1) && branches.includes(b2)) {
                    scores[element] += 16;
                }
            }

            const storageBranches = { 'Chen': 'Water', 'Wei': 'Wood', 'Xu': 'Fire', 'Chou': 'Metal' };
            knownPillars.forEach(p => {
                const storedElement = storageBranches[p.branch.char];
                if (storedElement) {
                    if (multiplier[storedElement] > 1.0) scores[storedElement] += 10;
                    else scores[storedElement] -= 8;
                }
            });

            return scores;
        }

        function analyzeDayMaster(pillars, scores) {
            const dmPillar = pillars.find(p => p.title === 'DAY');
            if (!dmPillar || dmPillar.isUnknown) return { strength: 'Tidak diketahui', structure: 'Tidak diketahui' };
            
            const dmElement = dmPillar.stem.element;
            const dmElementIndex = elementCycle.indexOf(dmElement);

            const resourceElement = elementCycle[(dmElementIndex + 4) % 5];
            const companionElement = dmElement;
            const outputElement = elementCycle[(dmElementIndex + 1) % 5];
            const wealthElement = elementCycle[(dmElementIndex + 2) % 5];
            const influenceElement = elementCycle[(dmElementIndex + 3) % 5];

            let totalScore = Object.values(scores).reduce((sum, val) => sum + Math.max(0, val), 0) || 1;
            const getPercentage = (element) => (Math.max(0, scores[element]) / totalScore) * 100;

            const supportingPercent = getPercentage(resourceElement) + getPercentage(companionElement);

            let isRooted = false;
            pillars.filter(p => !p.isUnknown).forEach(p => {
                if(p.branch.element === dmElement) isRooted = true;
                if(p.hidden.main && p.hidden.main.element === dmElement) isRooted = true;
                p.hidden.others.forEach(h => { if(h.element === dmElement) isRooted = true; });
            });

            if (supportingPercent < 15 && !isRooted) {
                const dominantElement = [outputElement, wealthElement, influenceElement].sort((a, b) => getPercentage(b) - getPercentage(a))[0];
                if (getPercentage(dominantElement) > 69) {
                    let structureName = '';
                    if (dominantElement === outputElement) structureName = 'Follower Output (食伤)';
                    else if (dominantElement === wealthElement) structureName = 'Follower Wealth (财)';
                    else if (dominantElement === influenceElement) structureName = 'Follower Influence (官杀)';
                    return { strength: 'Sangat Lemah', structure: `Bagan Spesial: ${structureName}` };
                }
            }
            
            let strength;
            if (supportingPercent > 69) strength = 'Sangat Kuat';
            else if (supportingPercent > 59.5) strength = 'Kuat';
            else if (supportingPercent > 54) strength = 'Agak Kuat';
            else if (supportingPercent > 50) strength = 'Seimbang';
            else if (supportingPercent > 30) strength = 'Cenderung Lemah';
            else if (supportingPercent > 15) strength = 'Lemah';
            else strength = 'Sangat Lemah';

            return { strength: strength, structure: 'Bagan Normal' };
        }

        function calculate10GodsStrength(pillars) {
            const scores = { F: 0, RW: 0, EG: 0, HO: 0, DW: 0, IW: 0, DO: 0, '7K': 0, DR: 0, IR: 0 };
            const knownPillars = pillars.filter(p => !p.isUnknown);
            if (knownPillars.length < 3) return scores;

            const seasonalStrengthMap = {
                'Yin': { Wood: 2.0, Fire: 1.5, Water: 1.2, Earth: 0.8, Metal: 0.6 }, 'Mao': { Wood: 2.2, Fire: 1.6, Water: 1.1, Earth: 0.7, Metal: 0.5 },
                'Chen': { Earth: 2.0, Wood: 1.4, Fire: 1.2, Metal: 0.8, Water: 0.7 }, 'Si': { Fire: 2.0, Earth: 1.5, Wood: 1.2, Metal: 0.8, Water: 0.6 },
                'Wu': { Fire: 2.2, Earth: 1.6, Wood: 1.1, Metal: 0.7, Water: 0.5 }, 'Wei': { Earth: 2.0, Fire: 1.4, Metal: 1.2, Wood: 0.8, Water: 0.7 },
                'Shen': { Metal: 2.0, Water: 1.5, Earth: 1.2, Fire: 0.8, Wood: 0.6 }, 'You': { Metal: 2.2, Water: 1.6, Earth: 1.1, Fire: 0.7, Wood: 0.5 },
                'Xu': { Earth: 2.0, Metal: 1.4, Fire: 1.2, Water: 0.8, Wood: 0.7 }, 'Hai': { Water: 2.0, Wood: 1.5, Metal: 1.2, Fire: 0.8, Earth: 0.6 },
                'Zi': { Water: 2.2, Wood: 1.6, Metal: 1.1, Fire: 0.7, Earth: 0.5 }, 'Chou': { Earth: 2.0, Water: 1.4, Metal: 1.2, Wood: 0.8, Fire: 0.7 }
            };
            const monthBranchPinyin = natalChartPillars[2].branch.pinyin;
            const multiplier = seasonalStrengthMap[monthBranchPinyin];
            const godCounts = {};

            knownPillars.forEach(p => {
                // Heavenly Stem
                if (p.stem.god && p.stem.god.abbr !== 'DM') {
                    let score = 15; // Base score for HS
                    if (p.title === 'MONTH' || p.title === 'DAY') score += 5; // Positional bonus
                    
                    const godElement = p.stem.element;
                    score *= multiplier[godElement];

                    let isRooted = false;
                    knownPillars.forEach(rootPillar => {
                        if (rootPillar.branch.element === godElement) isRooted = true;
                        if (rootPillar.hidden.main && rootPillar.hidden.main.element === godElement) isRooted = true;
                        rootPillar.hidden.others.forEach(h => { if (h.element === godElement) isRooted = true; });
                    });
                    if (!isRooted) score *= 0.3; // Penalty for not being rooted

                    scores[p.stem.god.abbr] += score;
                    godCounts[p.stem.god.abbr] = (godCounts[p.stem.god.abbr] || 0) + 1;
                }

                // Hidden Stems
                const processHiddenStem = (hs, baseScore) => {
                    if (hs && hs.god) {
                        let score = baseScore * multiplier[hs.element];
                        scores[hs.god.abbr] += score;
                        godCounts[hs.god.abbr] = (godCounts[hs.god.abbr] || 0) + 1;
                    }
                };
                processHiddenStem(p.hidden.main, 11);
                p.hidden.others.forEach(h => processHiddenStem(h, 8));
            });

            // Bonus for repetition & companion in season
            const dmElement = natalChartPillars[1].stem.element;
            for (const godAbbr in scores) {
                if (godCounts[godAbbr] > 1) {
                    scores[godAbbr] += (godCounts[godAbbr] - 1) * 5; // Repetition bonus
                }
                if ((godAbbr === 'F' || godAbbr === 'RW') && multiplier[dmElement] > 1.5) {
                    scores[godAbbr] += 16; // Companion in season bonus
                }
            }
            
            return scores;
        }


        // --- FUNGSI TAMPILAN (UI FUNCTIONS) ---
        function displayBaziChart(pillars, kongWangBranches) {
            const palaces = ["CHILDREN", "DESTINY", "CAREER", "MENTORS"];
            const relations = ["ASSETS", "RELATIONSHIP", "WEALTH", "FRIENDS"];
            const chartHtml = `
                <div class="bg-white border border-gray-200 rounded-lg shadow-lg overflow-hidden">
                    <div class="grid grid-cols-[auto,1fr]">
                        <div class="flex flex-col w-20">
                            <div class="flex-1 flex items-center justify-center p-2 border-r border-b border-white/20 bg-gray-700"><div class="vertical-text text-center text-white font-bold"><p class="text-xl mb-4 tracking-widest font-normal" style="font-family:'Noto Sans SC',sans-serif">天干</p><p class="text-base tracking-wider">Heavenly</p><p class="text-base tracking-wider">Stems</p></div></div>
                            <div class="flex-1 flex items-center justify-center p-2 border-r border-b border-white/20 bg-gray-700"><div class="vertical-text text-center text-white font-bold"><p class="text-xl mb-4 tracking-widest font-normal" style="font-family:'Noto Sans SC',sans-serif">地支</p><p class="text-base tracking-wider">Earthly</p><p class="text-base tracking-wider">Branches</p></div></div>
                            <div class="flex-1 flex items-center justify-center p-2 border-r bg-gray-700"><div class="vertical-text text-center text-white font-bold"><p class="text-xl mb-4 tracking-widest font-normal" style="font-family:'Noto Sans SC',sans-serif">藏干</p><p class="text-base tracking-wider">Hidden</p><p class="text-base tracking-wider">Stems</p></div></div>
                        </div>
                        <div class="horizontal-scroll-container overflow-x-auto">
                            <div class="flex flex-col min-w-[600px] md:min-w-full">
                                <div class="grid grid-cols-4">${pillars.map(p => `<div class="text-center py-2 border-b-2 border-gray-300"><p class="font-bold text-gray-800">${p.isUnknown ? "?" : `${p.title_cn} ${p.title}`}</p></div>`).join("")}</div>
                                <div class="grid grid-cols-4 flex-1">${pillars.map((p, i) => `
                                    <div class="flex flex-col text-center ${i === 1 ? "day-master-pillar" : ""} ${i < 3 ? "border-r border-gray-200" : ""}">
                                        ${p.isUnknown ? createEmptyCell("CHILDREN") : createStemCell(p, palaces[i])}
                                        ${p.isUnknown ? createEmptyCell("ASSETS") : createBranchCell(p, relations[i], kongWangBranches)}
                                        ${p.isUnknown ? createEmptyCell() : createHiddenStemsCell(p)}
                                    </div>`).join("")}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            dom.resultDiv.innerHTML = chartHtml;
        }
        function displayDayMasterAnalysis(analysis) {
            const content = `
                <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Analisis Day Master</h3>
                    <div class="flex justify-center items-center gap-4">
                         <p class="text-lg"><span class="font-semibold">Struktur Bagan:</span> ${analysis.structure}</p>
                         <p class="text-lg"><span class="font-semibold">Kekuatan:</span> ${analysis.strength}</p>
                    </div>
                </div>`;
            dom.dmAnalysisDiv.innerHTML = content;
        }
        function displayElementStrength(currentScores, title = "Peta Kekuatan Elemen", baseScores = null) {
            let totalCurrentScore = Object.values(currentScores).reduce((sum, val) => sum + Math.max(0, val), 0) || 1;
            let totalBaseScore = baseScores ? Object.values(baseScores).reduce((sum, val) => sum + Math.max(0, val), 0) || 1 : totalCurrentScore;

            const elementNames = { Wood: 'Kayu', Fire: 'Api', Earth: 'Tanah', Metal: 'Logam', Water: 'Air' };
            let resetButtonHtml = '';
            if (baseScores) {
                resetButtonHtml = `<button id="reset-analysis-btn" class="text-xs text-blue-600 hover:underline font-semibold ml-4">Reset ke Bagan Lahir</button>`;
            }

            let content = `<div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4">
                <div class="flex justify-center items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                    ${resetButtonHtml}
                </div>
                <div class="space-y-3">`;

            for (const element of elementCycle) {
                const currentScore = currentScores[element];
                const currentPercentage = Math.max(0, (currentScore / totalCurrentScore) * 100);
                
                let percentageColor = 'text-gray-700';
                let indicator = '';

                if (baseScores) {
                    const baseScore = baseScores[element];
                    const basePercentage = Math.max(0, (baseScore / totalBaseScore) * 100);
                    if (currentPercentage.toFixed(1) > basePercentage.toFixed(1)) {
                        percentageColor = 'text-green-600 font-bold';
                        indicator = '▲';
                    } else if (currentPercentage.toFixed(1) < basePercentage.toFixed(1)) {
                        percentageColor = 'text-red-600 font-bold';
                        indicator = '▼';
                    }
                }

                content += `<div class="w-full"><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700">${elementNames[element]}</span><span class="text-sm font-medium ${percentageColor}">${indicator} ${currentPercentage.toFixed(1)}%</span></div><div class="w-full strength-bar-bg rounded-full h-4"><div class="strength-bar bar-${element} h-4 rounded-full" style="width: 0%" data-width="${currentPercentage}%"></div></div></div>`;
            }
            content += `</div></div>`;
            dom.elementAnalysisDiv.innerHTML = content;

            setTimeout(() => { document.querySelectorAll('#element-strength-analysis .strength-bar').forEach(bar => { bar.style.width = bar.dataset.width; }); }, 100);
        }
        function display10GodsStrength(currentScores, baseScores = null) {
            let totalCurrentScore = Object.values(currentScores).reduce((sum, val) => sum + Math.max(0, val), 0) || 1;
            let totalBaseScore = baseScores ? Object.values(baseScores).reduce((sum, val) => sum + Math.max(0, val), 0) || 1 : totalCurrentScore;
            
            const dmElement = natalChartPillars[1].stem.element;
            const dmElementIndex = elementCycle.indexOf(dmElement);

            const godToElementMap = {
                F: elementCycle[dmElementIndex], RW: elementCycle[dmElementIndex],
                EG: elementCycle[(dmElementIndex + 1) % 5], HO: elementCycle[(dmElementIndex + 1) % 5],
                DW: elementCycle[(dmElementIndex + 2) % 5], IW: elementCycle[(dmElementIndex + 2) % 5],
                DO: elementCycle[(dmElementIndex + 3) % 5], '7K': elementCycle[(dmElementIndex + 3) % 5],
                DR: elementCycle[(dmElementIndex + 4) % 5], IR: elementCycle[(dmElementIndex + 4) % 5]
            };

            let content = `<div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Peta Kekuatan 10 Gods</h3>
                <div class="space-y-2">`;
            
            const sortedGods = Object.entries(currentScores).sort(([, a], [, b]) => b - a);

            for (const [godAbbr, score] of sortedGods) {
                const currentPercentage = Math.max(0, (score / totalCurrentScore) * 100);
                const godInfo = tenGods[godAbbr];
                const barElement = godToElementMap[godAbbr];

                let percentageColor = 'text-gray-700';
                let indicator = '';

                if (baseScores) {
                    const basePercentage = Math.max(0, (baseScores[godAbbr] / totalBaseScore) * 100);
                    if (currentPercentage.toFixed(1) > basePercentage.toFixed(1)) {
                        percentageColor = 'text-green-600 font-bold';
                        indicator = '▲';
                    } else if (currentPercentage.toFixed(1) < basePercentage.toFixed(1)) {
                        percentageColor = 'text-red-600 font-bold';
                        indicator = '▼';
                    }
                }

                content += `<div class="w-full"><div class="flex justify-between mb-1"><span class="text-xs font-medium text-gray-700">${godInfo.cn} ${godInfo.name} (${godAbbr})</span><span class="text-xs font-medium ${percentageColor}">${indicator} ${currentPercentage.toFixed(1)}%</span></div><div class="w-full strength-bar-bg rounded-full h-3"><div class="strength-bar bar-${barElement} h-3 rounded-full" style="width: 0%" data-width="${currentPercentage}%"></div></div></div>`;
            }
            content += `</div></div>`;
            dom.godsAnalysisDiv.innerHTML = content;
            
            setTimeout(() => { document.querySelectorAll('#gods-strength-analysis .strength-bar').forEach(bar => { bar.style.width = bar.dataset.width; }); }, 100);
        }
        function displayLuckPillars(luckPillarData, natalPillars, birthYear) {
            const container = dom.luckPillarResult;
            if (!luckPillarData || luckPillarData.error) { container.innerHTML = ``; return; }
            const dayMasterIndex = natalPillars[1].stemIndex;
            const currentYear = new Date().getFullYear();
            const currentAge = currentYear - birthYear;
            let pillarsHtml = '';
            luckPillarData.pillars.forEach((pillar, index) => {
                const stem = heavenlyStemsData[pillar.stemIndex];
                const branch = earthlyBranchesData[pillar.branchIndex];
                const isCurrent = currentAge >= pillar.startAge && currentAge <= pillar.endAge;
                const isVoid = activeKongWang.includes(branch.pinyin);
                const currentClass = isCurrent ? 'current' : '';
                const hiddenStemsHtml = renderCardHiddenStems(pillar.branchIndex, dayMasterIndex);
                pillarsHtml += `<div id="dayun-${index}" class="luck-pillar-card relative bg-white rounded-lg border-2 border-gray-200 p-3 w-48 flex-shrink-0 cursor-pointer hover:border-blue-400 transition-all duration-200 ${currentClass}" data-dayun-index="${index}" data-start-age="${pillar.startAge}" data-birth-year="${birthYear}" data-stem-index="${pillar.stemIndex}" data-branch-index="${pillar.branchIndex}"><div class="text-center"><p class="font-bold text-lg text-gray-600 bg-gray-100 rounded-t-md py-1">${pillar.startAge} - ${pillar.endAge}</p><div class="py-2"><p class="hanzi text-4xl">${stem.char}</p><p class="font-semibold">${stem.pinyin} / ${stem.polarity} ${stem.element}</p><p class="text-sm font-bold element-color-${stem.element} rounded-full w-6 h-6 mx-auto mt-1 flex items-center justify-center">${get10God(dayMasterIndex, pillar.stemIndex).abbr}</p></div><hr class="my-2"><div class="py-2"><p class="hanzi text-4xl">${branch.char}</p><p class="font-semibold">${branch.pinyin} / ${branch.polarity} ${branch.element}</p><p class="text-sm text-gray-500">${branch.shio_char} ${branch.shio}</p></div>${hiddenStemsHtml}</div> ${isVoid ? '<span class="kong-wang-indicator">DE</span>' : ''} </div>`;
            });
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Luck Pillars (大运)</h2><div class="horizontal-scroll-container overflow-x-auto pb-4"><div class="flex space-x-4 min-w-max px-2">${pillarsHtml}</div></div><div id="liunian-container" class="mt-6"></div>`;
        }
        function displayLiuNian(luckPillarCard) {
            const startAge = parseInt(luckPillarCard.dataset.startAge), birthYear = parseInt(luckPillarCard.dataset.birthYear), dayMasterIndex = natalChartPillars[1].stemIndex, currentFullYear = new Date().getFullYear();
            let cardsHtml = '';
            for (let i = 0; i < 10; i++) {
                const year = birthYear + startAge + i - 1, yearStemIndex = (year - 1924) % 10, yearBranchIndex = (year - 1924) % 12, stem = heavenlyStemsData[yearStemIndex], branch = earthlyBranchesData[yearBranchIndex], isCurrent = year === currentFullYear, isVoid = activeKongWang.includes(branch.pinyin), currentClass = isCurrent ? 'current' : '', hiddenStemsHtml = renderCardHiddenStems(yearBranchIndex, dayMasterIndex, true);
                cardsHtml += `<div id="liunian-${i}" class="liunian-card relative bg-white rounded-lg border border-gray-300 overflow-hidden text-center cursor-pointer hover:shadow-md hover:border-blue-400 transition-all duration-200 w-36 flex-shrink-0 flex flex-col ${currentClass}" data-year="${year}" data-stem-index="${yearStemIndex}" data-branch-index="${yearBranchIndex}"><p class="font-bold text-gray-700 bg-gray-100 py-1 w-full">${year}</p><div class="pt-2 pb-1 flex-grow"><p class="hanzi !text-3xl">${stem.char}</p><p class="text-sm">${stem.pinyin}</p><p class="text-xs font-bold element-color-${stem.element} rounded-full w-5 h-5 mx-auto mt-1 flex items-center justify-center text-xs">${get10God(dayMasterIndex, yearStemIndex).abbr}</p></div><hr class="w-full"/><div class="pt-1 pb-2 flex-grow"><p class="hanzi !text-3xl">${branch.char}</p><p class="text-sm">${branch.pinyin}</p>${hiddenStemsHtml}</div> ${isVoid ? '<span class="kong-wang-indicator">DE</span>' : ''} </div>`;
            }
            const container = document.getElementById('liunian-container');
            container.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Annual Pillars (流年) for Age ${startAge}-${startAge + 9}</h3><div class="horizontal-scroll-container overflow-x-auto pb-4"><div class="flex space-x-4 min-w-max px-2">${cardsHtml}</div></div><div id="liuyue-container" class="mt-6"></div>`;
        }
        function displayLiuYue(liuNianCard, dayMasterIndex) {
            const year = parseInt(liuNianCard.dataset.year), yearStemIndex = parseInt(liuNianCard.dataset.stemIndex);
            const firstMonthStemIndexMap = { 0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0 };
            let currentMonthStemIndex = firstMonthStemIndexMap[yearStemIndex], currentMonthBranchIndex = 2;
            const monthNames = ["Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan"];
            let cardsHtml = '';
            for (let i = 0; i < 12; i++) {
                const stem = heavenlyStemsData[currentMonthStemIndex], branch = earthlyBranchesData[currentMonthBranchIndex], isVoid = activeKongWang.includes(branch.pinyin), hiddenStemsHtml = renderCardHiddenStems(currentMonthBranchIndex, dayMasterIndex, true), god = get10God(dayMasterIndex, currentMonthStemIndex);
                cardsHtml += `<div class="bg-white rounded-lg border text-center w-32 flex-shrink-0 flex flex-col overflow-hidden relative"><p class="font-semibold text-sm bg-gray-100 py-1 w-full">${monthNames[i]}</p><div class="pt-2 pb-1 flex-grow"><p class="hanzi !text-2xl">${stem.char}</p><p class="text-xs">${stem.pinyin}</p><p class="text-[10px] font-bold element-color-${stem.element} rounded-full w-4 h-4 mx-auto mt-1 flex items-center justify-center">${god.abbr}</p></div><hr class="w-full"/><div class="pt-1 pb-2 flex-grow"><p class="hanzi !text-2xl">${branch.char}</p><p class="text-xs">${branch.pinyin}</p>${hiddenStemsHtml}</div> ${isVoid ? '<span class="kong-wang-indicator">DE</span>' : ''} </div>`;
                currentMonthStemIndex = (currentMonthStemIndex + 1) % 10;
                currentMonthBranchIndex = (currentMonthBranchIndex + 1) % 12;
            }
            const container = document.getElementById('liuyue-container');
            container.innerHTML = `<h4 class="text-lg font-bold text-gray-800 mb-4 text-center">Monthly Pillars (流月) for ${year}</h4><div class="horizontal-scroll-container overflow-x-auto pb-4"><div class="flex space-x-3 min-w-max px-2">${cardsHtml}</div></div>`;
        }

        // --- FUNGSI PEMBANTU TAMPILAN & LOGIKA ---
        function createTemporaryPillar(stemIndex, branchIndex, dayMasterIndex) {
            const stem = heavenlyStemsData[stemIndex]; const branch = earthlyBranchesData[branchIndex]; const hidden = branch.hidden; const mainHidden = hidden.mainQi !== null ? heavenlyStemsData[hidden.mainQi] : null; const otherHidden = hidden.otherQi.map(i => heavenlyStemsData[i]);
            return { isUnknown: false, stem: { ...stem, god: get10God(dayMasterIndex, stemIndex) }, branch: branch, hidden: { main: mainHidden ? { ...mainHidden, god: get10God(dayMasterIndex, hidden.mainQi) } : null, others: otherHidden.map((h, i) => ({ ...h, god: get10God(dayMasterIndex, hidden.otherQi[i]) })) }, stemIndex: stemIndex, branchIndex: branchIndex };
        }
        function createStemCell(pillar, palace) { return `<div class="relative flex-1 p-4 border-b border-gray-200 min-h-[140px] flex flex-col justify-center" data-stem-index="${pillar.stemIndex}"><div class="absolute top-2 left-2 text-left"><p class="font-semibold text-gray-500 text-xs">${pillar.stem.god.cn}</p><p class="text-gray-400 text-xs">${pillar.stem.god.abbr}</p></div><p class="text-green-700 font-bold text-sm uppercase tracking-wide">${palace}</p><p class="hanzi mt-1">${pillar.stem.char}</p><p class="font-semibold text-gray-700">${pillar.stem.pinyin}</p><p class="text-sm text-gray-500">${pillar.stem.polarity} ${pillar.stem.element}</p></div>`; }
        function createBranchCell(pillar, relation, kongWangBranches) { const isVoid = kongWangBranches.includes(pillar.branch.pinyin); return `<div class="relative flex-1 p-4 border-b border-gray-200 min-h-[140px] flex flex-col justify-center"><p class="text-blue-700 font-bold text-sm uppercase tracking-wide">${relation}</p><p class="hanzi mt-1">${pillar.branch.char}</p><p class="font-semibold text-gray-700">${pillar.branch.pinyin} / ${pillar.branch.shio_char} ${pillar.branch.shio}</p><p class="text-sm text-gray-500">${pillar.branch.polarity} ${pillar.branch.element}</p> ${isVoid ? '<span class="kong-wang-indicator">DE</span>' : ''} </div>`; }
        function createHiddenStemsCell(pillar) { return `<div class="flex-1 p-4 flex justify-around items-center min-h-[90px]">${renderHiddenStems(pillar.hidden)}</div>`; }
        function createEmptyCell(title = "") { return `<div class="flex-1 p-4 border-b border-gray-200 min-h-[120px] flex flex-col justify-center items-center bg-gray-50">${title ? `<p class="text-gray-400 font-bold text-sm uppercase tracking-wide">${title}</p>` : ''}<p class="text-gray-400 text-2xl mt-4">?</p><p class="text-gray-400 text-sm mt-1">Data Unknown</p></div>`; }
        function renderHiddenStems(hiddenStems) { const displayOrder = []; hiddenStems.others[1] ? displayOrder.push(hiddenStems.others[1]) : displayOrder.push(null); displayOrder.push(hiddenStems.main); hiddenStems.others[0] ? displayOrder.push(hiddenStems.others[0]) : displayOrder.push(null); if (hiddenStems.others.length === 1 && (hiddenStems.main.pinyin === 'Ding' || hiddenStems.main.pinyin === 'Ren')) { displayOrder[0] = hiddenStems.others[0]; displayOrder[2] = null; } return displayOrder.map(stem => { if (!stem) return '<div class="w-1/3"></div>'; return `<div class="w-1/3 text-center"><p class="font-bold text-lg">${stem.char}</p><p class="text-xs text-gray-600">${stem.pinyin}</p><p class="text-xs text-gray-500">${stem.polarity.slice(0, 1)}${stem.element.slice(0, 1)}</p><p class="text-xs font-semibold text-blue-600">${stem.god.abbr}</p></div>`; }).join(''); }
        function renderCardHiddenStems(branchIndex, dayMasterIndex, isCompact = false) {
            const branch = earthlyBranchesData[branchIndex]; if (!branch || !branch.hidden) return '';
            const hiddenStemsData = branch.hidden, mainHidden = hiddenStemsData.mainQi !== null ? heavenlyStemsData[hiddenStemsData.mainQi] : null, otherHidden = hiddenStemsData.otherQi.map(i => heavenlyStemsData[i]);
            const stemData = [mainHidden, ...otherHidden].filter(Boolean); if (stemData.length === 0) return '';
            const charSize = isCompact ? '!text-lg' : '!text-xl', godSize = isCompact ? 'text-[10px]' : 'text-xs';
            const html = stemData.map(stem => { const stemIndex = heavenlyStemsData.findIndex(s => s.char === stem.char), god = get10God(dayMasterIndex, stemIndex); return `<div class="text-center"><p class="hanzi ${charSize}">${stem.char}</p><p class="${godSize} text-gray-500">${god.abbr}</p></div>`; }).join('');
            return `<div class="card-hidden-stems gap-2 ${isCompact ? 'compact' : ''}">${html}</div>`;
        }

        // --- INISIALISASI HALAMAN & EVENT LISTENERS ---
        function populateDaySelector() { const year = parseInt(dom.birthYearInput.value), month = parseInt(dom.birthMonthInput.value), daysInMonth = new Date(year, month + 1, 0).getDate(), selectedDay = parseInt(dom.birthDayInput.value); dom.birthDayInput.innerHTML = ""; for (let i = 1; i <= daysInMonth; i++) dom.birthDayInput.innerHTML += `<option value="${i}">${i}</option>`; dom.birthDayInput.value = selectedDay <= daysInMonth ? selectedDay : daysInMonth; }
        function initializePage() { const today = new Date(), currentYear = today.getFullYear(), currentMonth = today.getMonth(), currentDay = today.getDate(); for (let y = currentYear + 5; y >= 1924; y--) dom.birthYearInput.innerHTML += `<option value="${y}">${y}</option>`; const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; months.forEach((m, i) => { dom.birthMonthInput.innerHTML += `<option value="${i}">${m}</option>`; }); dom.birthYearInput.value = currentYear; dom.birthMonthInput.value = currentMonth; populateDaySelector(); dom.birthDayInput.value = currentDay; for (let h = 0; h < 24; h++) dom.birthHourInput.innerHTML += `<option value="${h.toString().padStart(2, '0')}">${h.toString().padStart(2, '0')}</option>`; for (let m = 0; m < 60; m++) dom.birthMinuteInput.innerHTML += `<option value="${m.toString().padStart(2, '0')}">${m.toString().padStart(2, '0')}</option>`; dom.birthHourInput.value = today.getHours().toString().padStart(2, '0'); dom.birthMinuteInput.value = today.getMinutes().toString().padStart(2, '0'); }
        
        initializePage();
        dom.unknownBirthHourCheckbox.addEventListener('change', () => { dom.birthHourInput.disabled = dom.unknownBirthHourCheckbox.checked; dom.birthMinuteInput.disabled = dom.unknownBirthHourCheckbox.checked; });
        dom.birthYearInput.addEventListener('change', populateDaySelector);
        dom.birthMonthInput.addEventListener('change', populateDaySelector);
        
        // Main Calculation Trigger
        dom.calculateBtn.addEventListener("click", () => {
            const baziData = calculateBaziChart();
            if (baziData) {
                natalChartPillars = baziData.processedPillars;
                natalChartScores = calculateElementStrength(natalChartPillars);
                natalDayMasterAnalysis = analyzeDayMaster(natalChartPillars, natalChartScores);
                natalGodsScores = calculate10GodsStrength(natalChartPillars);
                
                displayDayMasterAnalysis(natalDayMasterAnalysis);
                displayElementStrength(natalChartScores, "Analisis Bagan Kelahiran");
                display10GodsStrength(natalGodsScores);

                const gender = dom.genderInput.value;
                const birthYear = parseInt(dom.birthYearInput.value);
                const luckPillars = calculateLuckPillars(baziData.processedPillars, gender);
                displayLuckPillars(luckPillars, baziData.processedPillars, birthYear);
            }
        });

        // Global Reset Trigger
        dom.resetAllBtn.addEventListener("click", () => {
            dom.resultDiv.innerHTML = "";
            dom.luckPillarResult.innerHTML = "";
            dom.elementAnalysisDiv.innerHTML = "";
            dom.dmAnalysisDiv.innerHTML = "";
            dom.godsAnalysisDiv.innerHTML = "";
            natalChartPillars = [];
            natalChartScores = null;
            natalDayMasterAnalysis = null;
            natalGodsScores = null;
            initializePage();
        });

        // Event Delegation for Dynamic Analysis & Reset
        dom.elementAnalysisDiv.addEventListener("click", e => {
            if (e.target && e.target.id === 'reset-analysis-btn') {
                displayElementStrength(natalChartScores, "Analisis Bagan Kelahiran");
                displayDayMasterAnalysis(natalDayMasterAnalysis);
                display10GodsStrength(natalGodsScores);
                document.querySelectorAll(".luck-pillar-card.active, .liunian-card.active").forEach(c => c.classList.remove("active"));
                document.getElementById('liunian-container').innerHTML = '';
            }
        });

        dom.luckPillarResult.addEventListener("click", e => {
            if (natalChartPillars.length === 0) return;
            const dayMasterIndex = natalChartPillars[1].stemIndex;

            const luckPillarCard = e.target.closest(".luck-pillar-card");
            const liuNianCard = e.target.closest(".liunian-card");

            if (luckPillarCard) {
                document.querySelectorAll(".luck-pillar-card.active").forEach(c => c.classList.remove("active"));
                luckPillarCard.classList.add("active");

                const dayunStemIndex = parseInt(luckPillarCard.dataset.stemIndex);
                const dayunBranchIndex = parseInt(luckPillarCard.dataset.branchIndex);
                const dayunPillar = createTemporaryPillar(dayunStemIndex, dayunBranchIndex, dayMasterIndex);
                
                const currentScores = calculateElementStrength(natalChartPillars, [dayunPillar]);
                const currentAnalysis = analyzeDayMaster(natalChartPillars.concat([dayunPillar]), currentScores);
                displayDayMasterAnalysis(currentAnalysis);

                const startAge = luckPillarCard.dataset.startAge;
                displayElementStrength(currentScores, `Analisis Dayun Usia ${startAge}-${parseInt(startAge)+9}`, natalChartScores);
                
                const godsScores = calculate10GodsStrength(natalChartPillars.concat([dayunPillar]));
                display10GodsStrength(godsScores, natalGodsScores);
                
                const liuYueContainer = document.getElementById('liuyue-container');
                if(liuYueContainer) liuYueContainer.innerHTML = "";

                displayLiuNian(luckPillarCard);
            }

            if (liuNianCard) {
                document.querySelectorAll(".liunian-card.active").forEach(c => c.classList.remove("active"));
                liuNianCard.classList.add("active");

                const activeDayunCard = document.querySelector('.luck-pillar-card.active');
                const dayunStemIndex = parseInt(activeDayunCard.dataset.stemIndex);
                const dayunBranchIndex = parseInt(activeDayunCard.dataset.branchIndex);
                const dayunPillar = createTemporaryPillar(dayunStemIndex, dayunBranchIndex, dayMasterIndex);

                const liunianStemIndex = parseInt(liuNianCard.dataset.stemIndex);
                const liunianBranchIndex = parseInt(liuNianCard.dataset.branchIndex);
                const liunianPillar = createTemporaryPillar(liunianStemIndex, liunianBranchIndex, dayMasterIndex);

                const currentPillars = natalChartPillars.concat([dayunPillar, liunianPillar]);
                const currentScores = calculateElementStrength(natalChartPillars, [dayunPillar, liunianPillar]);
                const currentAnalysis = analyzeDayMaster(currentPillars, currentScores);
                displayDayMasterAnalysis(currentAnalysis);
                
                const year = liuNianCard.dataset.year;
                displayElementStrength(currentScores, `Analisis Tahun ${year}`, natalChartScores);

                const godsScores = calculate10GodsStrength(currentPillars);
                display10GodsStrength(godsScores, natalGodsScores);

                displayLiuYue(liuNianCard, dayMasterIndex);
            }
        });

    });
    </script>
</body>
</html>
