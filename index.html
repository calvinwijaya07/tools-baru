<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolskit Bazi Pro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .chart-bar { transition: width 0.5s ease-in-out; }

        .pillar-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            width: 160px;
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, border-color 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .pillar-card:hover {
            transform: translateY(-5px);
            border-color: #4b5563;
        }
        .element-dot {
            display: block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-top: 4px;
        }
        .current-dayun-highlight {
            border-color: #f59e0b; /* amber-500 */
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .selected-dayun-analysis {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6), 0 0 5px rgba(59, 130, 246, 0.4);
            transform: scale(1.05);
        }
        .selected-liunian-analysis {
            border-color: #10b981; /* emerald-500 */
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
            transform: scale(1.05);
        }
        .shen-sha-list {
            font-size: 0.7rem;
            line-height: 1.2;
            color: #9ca3af;
            min-height: 40px;
        }
        .shen-sha-item {
            display: block;
            margin-bottom: 2px;
        }
        /* Life Aspect Dashboard Styles */
        .aspect-bar-bg {
            background-color: #374151; /* gray-700 */
            border-radius: 0.375rem; /* rounded-md */
            height: 2.5rem; /* h-10 */
            display: flex;
            align-items: flex-end; /* Bars grow from bottom */
        }
        .aspect-bar {
            transition: height 0.7s ease-in-out;
            width: 100%;
            border-radius: 0.375rem; /* rounded-md */
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Kalkulator Bazi (八字)</h1>
            <p class="text-gray-400 mt-2">Hitung 4 Pilar, Siklus Keberuntungan & Analisis Kekuatan Elemen</p>
        </header>

        <!-- Kalkulator Bazi Utama -->
        <section class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6">
            <h2 class="text-xl font-bold text-white mb-4">Masukkan Data Kelahiran</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">Tanggal Lahir</label>
                    <div class="flex items-center gap-2">
                         <select id="birth-day" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                         <select id="birth-month" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                         <select id="birth-year" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                    </div>
                </div>
                <div id="time-container" class="transition-opacity">
                    <label class="block mb-2 text-sm font-medium text-gray-300">Jam Lahir (24 Jam)</label>
                    <div class="flex items-center gap-2">
                         <select id="birth-hour" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                         <span class="font-bold text-gray-400">:</span>
                         <select id="birth-minute" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></select>
                    </div>
                </div>
                 <div>
                    <label for="gender-select" class="block mb-2 text-sm font-medium text-gray-300">Jenis Kelamin</label>
                    <select id="gender-select" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="Pria">Pria</option>
                        <option value="Wanita">Wanita</option>
                    </select>
                </div>
                <div class="flex items-end pb-2">
                    <div class="flex items-center">
                        <input id="unknown-hour-checkbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600">
                        <label for="unknown-hour-checkbox" class="ml-2 text-sm font-medium text-gray-300">Jam Lahir Tidak Diketahui</label>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                 <button id="reset-btn" class="w-full px-5 py-3 text-sm font-medium text-center text-white bg-gray-600 rounded-lg hover:bg-gray-500 focus:ring-4 focus:outline-none focus:ring-gray-700">Reset Data</button>
                 <button id="calculate-bazi-btn" class="w-full px-5 py-3 text-sm font-medium text-center text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800">Hitung Bazi</button>
            </div>
        </section>

        <!-- Hasil Bazi Chart -->
        <div id="bazi-chart-result" class="mt-8">
            <p class="text-center text-gray-400">Hasil Bazi Chart akan ditampilkan di sini.</p>
        </div>

        <!-- Hasil Luck Pillar (Dayun) -->
        <div id="luck-pillar-result" class="mt-8"></div>

        <!-- Hasil Annual Pillar (Liunian) -->
        <div id="annual-pillar-result" class="mt-8"></div>

        <!-- Konteks Analisis Dinamis -->
        <div id="analysis-context-div" class="mt-8"></div>

        <!-- Panel Interaksi Dinamis -->
        <div id="dynamic-interaction-panel" class="mt-4"></div>

        <!-- Dasbor Aspek Kehidupan -->
        <div id="life-aspects-dashboard" class="mt-8"></div>

        <!-- Hasil Analisis Kekuatan Elemen -->
        <div id="element-strength-result" class="mt-8"></div>

        <!-- Hasil Peta Distribusi 10 Gods -->
        <div id="ten-gods-distribution-result" class="mt-8"></div>
        
        <!-- Hasil Ming Gua & Ba Zhai -->
        <div id="ming-gua-ba-zhai-result" class="mt-8"></div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- STATE MANAGEMENT ---
        let natalChartData = null; 
        let selectedDayun = null; 
        let selectedLiunian = null;
        let natalLifeAspects = null; // Store natal scores for comparison

        // --- DATA BAZI LENGKAP ---
        const heavenlyStems = [
            { char: '甲', pinyin: 'Jia', element: 'Wood', polarity: 'Yang', index: 0 }, { char: '乙', pinyin: 'Yi', element: 'Wood', polarity: 'Yin', index: 1 },
            { char: '丙', pinyin: 'Bing', element: 'Fire', polarity: 'Yang', index: 2 }, { char: '丁', pinyin: 'Ding', element: 'Fire', polarity: 'Yin', index: 3 },
            { char: '戊', pinyin: 'Wu', element: 'Earth', polarity: 'Yang', index: 4 }, { char: '己', pinyin: 'Ji', element: 'Earth', polarity: 'Yin', index: 5 },
            { char: '庚', pinyin: 'Geng', element: 'Metal', polarity: 'Yang', index: 6 }, { char: '辛', pinyin: 'Xin', element: 'Metal', polarity: 'Yin', index: 7 },
            { char: '壬', pinyin: 'Ren', element: 'Water', polarity: 'Yang', index: 8 }, { char: '癸', pinyin: 'Gui', element: 'Water', polarity: 'Yin', index: 9 }
        ];
        const earthlyBranches = [
            { char: '子', pinyin: 'Zi', animal: 'Rat', element: 'Water', polarity: 'Yang', index: 0 }, { char: '丑', pinyin: 'Chou', animal: 'Ox', element: 'Earth', polarity: 'Yin', index: 1 },
            { char: '寅', pinyin: 'Yin', animal: 'Tiger', element: 'Wood', polarity: 'Yang', index: 2 }, { char: '卯', pinyin: 'Mao', animal: 'Rabbit', element: 'Wood', polarity: 'Yin', index: 3 },
            { char: '辰', pinyin: 'Chen', animal: 'Dragon', element: 'Earth', polarity: 'Yang', index: 4 }, { char: '巳', pinyin: 'Si', animal: 'Snake', element: 'Fire', polarity: 'Yin', index: 5 },
            { char: '午', pinyin: 'Wu', animal: 'Horse', element: 'Fire', polarity: 'Yang', index: 6 }, { char: '未', pinyin: 'Wei', animal: 'Goat', element: 'Earth', polarity: 'Yin', index: 7 },
            { char: '申', pinyin: 'Shen', animal: 'Monkey', element: 'Metal', polarity: 'Yang', index: 8 }, { char: '酉', pinyin: 'You', animal: 'Rooster', element: 'Metal', polarity: 'Yin', index: 9 },
            { char: '戌', pinyin: 'Xu', animal: 'Dog', element: 'Earth', polarity: 'Yang', index: 10 }, { char: '亥', pinyin: 'Hai', animal: 'Pig', element: 'Water', polarity: 'Yin', index: 11 }
        ];
        const hiddenStemsData = {
            '子': [9], '丑': [9, 7, 5], '寅': [0, 2, 4], '卯': [1], '辰': [4, 1, 9], '巳': [2, 6, 4],
            '午': [3, 5], '未': [3, 1, 5], '申': [6, 8, 4], '酉': [7], '戌': [4, 7, 3], '亥': [8, 0]
        };
        const elementColors = { 'Wood': 'bg-green-500', 'Fire': 'bg-red-500', 'Earth': 'bg-yellow-600', 'Metal': 'bg-gray-400', 'Water': 'bg-blue-500' };
        const tenGods = {
            'Wood': {'Wood': {same: 'F', diff: 'RW'}, 'Fire': {same: 'EG', diff: 'HO'}, 'Earth': {same: 'IW', diff: 'DW'}, 'Metal': {same: '7K', diff: 'DO'}, 'Water': {same: 'IR', diff: 'DR'}},
            'Fire': {'Fire': {same: 'F', diff: 'RW'}, 'Earth': {same: 'EG', diff: 'HO'}, 'Metal': {same: 'IW', diff: 'DW'}, 'Water': {same: '7K', diff: 'DO'}, 'Wood': {same: 'IR', diff: 'DR'}},
            'Earth': {'Earth': {same: 'F', diff: 'RW'}, 'Metal': {same: 'EG', diff: 'HO'}, 'Water': {same: 'IW', diff: 'DW'}, 'Wood': {same: '7K', diff: 'DO'}, 'Fire': {same: 'IR', diff: 'DR'}},
            'Metal': {'Metal': {same: 'F', diff: 'RW'}, 'Water': {same: 'EG', diff: 'HO'}, 'Wood': {same: 'IW', diff: 'DW'}, 'Fire': {same: '7K', diff: 'DO'}, 'Earth': {same: 'IR', diff: 'DR'}},
            'Water': {'Water': {same: 'F', diff: 'RW'}, 'Wood': {same: 'EG', diff: 'HO'}, 'Fire': {same: 'IW', diff: 'DW'}, 'Earth': {same: '7K', diff: 'DO'}, 'Metal': {same: 'IR', diff: 'DR'}}
        };
        const solarMonthStartDates = [6, 5, 6, 5, 6, 6, 7, 8, 8, 9, 8, 7];
        const elementCycle = ['Wood', 'Fire', 'Earth', 'Metal', 'Water'];

        // --- DATA 12 QI STAGE ---
        const qiStagesNames = ['長生 (Growth)', '沐浴 (Bath)', '冠帶 (Girdle)', '臨官 (Official Hat)', '帝旺 (Emperor)', '衰 (Decline)', '病 (Sickness)', '死 (Death)', '墓 (Tomb)', '絕 (Extinction)', '胎 (Conception)', '養 (Nurturing)'];
        const stemQiGrowthBranchIndex = { 0: 11, 1: 6, 2: 2, 3: 9, 4: 2, 5: 9, 6: 5, 7: 0, 8: 8, 9: 3 };
        function get12QiStage(dayMasterStemIndex, branchIndex) {
            const dayMasterStem = heavenlyStems[dayMasterStemIndex];
            const growthBranchIndex = stemQiGrowthBranchIndex[dayMasterStemIndex];
            let stageIndex = (dayMasterStem.polarity === 'Yang') ? (branchIndex - growthBranchIndex + 12) % 12 : (growthBranchIndex - branchIndex + 12) % 12;
            return qiStagesNames[stageIndex].split('(')[1].replace(')', ''); 
        }

        // --- DATA SHEN SHA ---
        const EARTHLY_BRANCHES = earthlyBranches.map(b => b.char);
        function getBranchFrame(branchChar) {
            if (['寅', '午', '戌'].includes(branchChar)) return 'Fire';
            if (['申', '子', '辰'].includes(branchChar)) return 'Water';
            if (['巳', '酉', '丑'].includes(branchChar)) return 'Metal';
            if (['亥', '卯', '未'].includes(branchChar)) return 'Wood';
            return null;
        }
        const SPECIAL_STARS_RULES = {
            NOBLE_PEOPLE: { '甲': ['丑', '未'], '戊': ['丑', '未'], '庚': ['丑', '未'], '乙': ['子', '申'], '己': ['子', '申'], '丙': ['亥', '酉'], '丁': ['亥', '酉'], '壬': ['卯', '巳'], '癸': ['卯', '巳'], '辛': ['寅', '午'] },
            CELESTIAL_NOBLE_BY_BRANCH: { '子': ['丑', '未'], '丑': ['子', '申'], '寅': ['酉', '亥'], '卯': ['酉', '亥'], '辰': ['子', '申'], '巳': ['酉', '亥'], '午': ['酉', '亥'], '未': ['子', '申'], '申': ['丑', '未'], '酉': ['寅', '午'], '戌': ['寅', '午'], '亥': ['寅', '午'] },
            TAI_JI_NOBLE: { '甲': ['子', '午'], '乙': ['丑', '亥'], '丙': ['卯', '酉'], '丁': ['寅', '申'], '戊': ['辰', '戌'], '己': ['丑', '未'], '庚': ['寅', '申'], '辛': ['巳', '亥'], '壬': ['辰', '戌'], '癸': ['卯', '酉'] },
            INTELLIGENCE: { '甲': '巳', '乙': '午', '丙': '申', '丁': '酉', '戊': '申', '己': '酉', '庚': '亥', '辛': '子', '壬': '寅', '癸': '卯' },
            PEACH_BLOSSOM: { '寅': '卯', '午': '卯', '戌': '卯', '巳': '午', '酉': '午', '丑': '午', '申': '酉', '子': '酉', '辰': '酉', '亥': '子', '卯': '子', '未': '子' },
            SKY_HORSE: { '寅': '申', '午': '申', '戌': '申', '申': '寅', '子': '寅', '辰': '寅', '巳': '亥', '酉': '亥', '丑': '亥', '亥': '巳', '卯': '巳', '未': '巳' },
            SOLITARY_STAR: { '寅': '巳', '卯': '巳', '辰': '巳', '巳': '申', '午': '申', '未': '申', '申': '亥', '酉': '亥', '戌': '亥', '亥': '寅', '子': '寅', '丑': '寅' }
        };
        const INTERACTIONS = { PUNISHMENT: { UNGRATEFUL: { 'Zi': 'Mao', 'Mao': 'Zi', 'Yin': 'Si', 'Si': 'Shen', 'Shen': 'Yin', 'Chou': 'Xu', 'Xu': 'Wei', 'Wei': 'Chou' } } };
        const ADDITIONAL_SHEN_SHA_RULES_DEF = { RED_MATCHMAKER: { 'Zi': 'Mao', 'Chou': 'Yin', 'Yin': 'Chou', 'Mao': 'Zi', 'Chen': 'Hai', 'Si': 'Xu', 'Wu': 'You', 'Wei': 'Shen', 'Shen': 'Wei', 'You': 'Wu', 'Xu': 'Si', 'Hai': 'Chen' }, RED_CHAMBER: { 'Jia': 'Wu', 'Yi': 'Shen', 'Bing': 'Yin', 'Ding': 'Wei', 'Wu': 'Chen', 'Ji': 'Chen', 'Geng': 'Xu', 'Xin': 'You', 'Ren': 'Zi', 'Gui': 'Shen' }, GOLD_CARRIAGE: { 'Jia': 'Chen', 'Yi': 'Si', 'Bing': 'Wei', 'Ding': 'Shen', 'Wu': 'Wei', 'Ji': 'Shen', 'Geng': 'Xu', 'Xin': 'Hai', 'Ren': 'Chou', 'Gui': 'Yin' }, FLYING_BLADE: { 'Zi': 'Mao', 'Chou': 'Chen', 'Yin': 'Si', 'Mao': 'Wu', 'Chen': 'Wei', 'Si': 'Shen', 'Wu': 'You', 'Wei': 'Xu', 'Shen': 'Hai', 'You': 'Zi', 'Xu': 'Chou', 'Hai': 'Yin' }, LITIGATION: { 'Zi': 'Si', 'Chou': 'Wu', 'Yin': 'Wei', 'Mao': 'Shen', 'Chen': 'You', 'Si': 'Xu', 'Wu': 'Hai', 'Wei': 'Zi', 'Shen': 'Chou', 'You': 'Yin', 'Xu': 'Mao', 'Hai': 'Chen' }, CASCADING_CLOUDS: { 'Jia': 'You', 'Yi': 'Xu', 'Bing': 'Chou', 'Ding': 'Yin', 'Wu': 'Mao', 'Ji': 'Chen', 'Geng': 'Wu', 'Xin': 'Wei', 'Ren': 'Shen', 'Gui': 'Hai' }, STUDY_HALL: { 'Jia': 'Hai', 'Yi': 'Wu', 'Bing': 'Yin', 'Ding': 'You', 'Wu': 'Yin', 'Ji': 'You', 'Geng': 'Si', 'Xin': 'Zi', 'Ren': 'Shen', 'Gui': 'Mao' }, SICKNESS: (yearBranch) => EARTHLY_BRANCHES[(EARTHLY_BRANCHES.indexOf(yearBranch) + 11) % 12], FIVE_GHOST: (yearBranch) => EARTHLY_BRANCHES[(EARTHLY_BRANCHES.indexOf(yearBranch) + 4) % 12], BLOOD_KNIFE: { 'Fire': 'Mao', 'Water': 'You', 'Metal': 'Wu', 'Wood': 'Zi' }, FORTUNE_VIRTUE: { 'Jia': 'Yin', 'Ji': 'Yin', 'Yi': 'Zi', 'Geng': 'Zi', 'Bing': 'Shen', 'Xin': 'Shen', 'Ding': 'Wu', 'Ren': 'Wu', 'Wu': 'Chen', 'Gui': 'Chen' }, GOLDEN_LOCK: { 'Jia': 'Chou', 'Yi': 'Yin', 'Bing': 'Si', 'Ding': 'Wu', 'Wu': 'Wei', 'Ji': 'Shen', 'Geng': 'You', 'Xin': 'Xu', 'Ren': 'Hai', 'Gui': 'Zi' } }; 
        const NEW_SHEN_SHA_RULES_DEF = { TIAN_DE_STEM: { 'Yin': 'Ding', 'Mao': 'Shen', 'Chen': 'Ren', 'Si': 'Xin', 'Wu': 'Hai', 'Wei': 'Jia', 'Shen': 'Gui', 'You': 'Yin', 'Xu': 'Bing', 'Hai': 'Yi', 'Zi': 'Si', 'Chou': 'Geng' }, YUE_DE_STEM: { 'Fire': 'Bing', 'Metal': 'Geng', 'Water': 'Ren', 'Wood': 'Jia' }, GENERAL_STAR: { 'Fire': 'Wu', 'Metal': 'You', 'Water': 'Zi', 'Wood': 'Mao' }, ELEGANT_SEAL: { 'Fire': 'Xu', 'Metal': 'Chou', 'Water': 'Chen', 'Wood': 'Wei' }, ROBBERY_SHA: { 'Fire': 'Hai', 'Metal': 'Yin', 'Water': 'Si', 'Wood': 'Shen' }, MOURNING_DOOR: (yearBranch) => EARTHLY_BRANCHES[(EARTHLY_BRANCHES.indexOf(yearBranch) + 2) % 12], SEPARATING_EDGE: { 'Fire': 'You', 'Metal': 'Mao', 'Water': 'Wei', 'Wood': 'Chou' } }; 
        const SHEN_SHA_DATABASE = { 'Noble People': { rule: (p, chart) => (SPECIAL_STARS_RULES.NOBLE_PEOPLE[chart.day.stem] || []).includes(p.branch), color: 'text-green-400 font-semibold' }, 'Celestial Nobleman':{ rule: (p, chart) => { const noble = SPECIAL_STARS_RULES.NOBLE_PEOPLE[chart.day.stem] || []; const celestial = SPECIAL_STARS_RULES.CELESTIAL_NOBLE_BY_BRANCH[chart.day.branch] || []; const isSame = noble.sort().join(',') === celestial.sort().join(','); return !isSame && celestial.includes(p.branch); }, color: 'text-green-400 font-semibold' }, 'Tai Ji Nobleman': { rule: (p, chart) => (SPECIAL_STARS_RULES.TAI_JI_NOBLE[chart.day.stem] || []).includes(p.branch), color: 'text-green-400 font-semibold' }, 'Intelligence': { rule: (p, chart) => SPECIAL_STARS_RULES.INTELLIGENCE[chart.day.stem] === p.branch, color: 'text-blue-400' }, 'Peach Blossom': { rule: (p, chart) => SPECIAL_STARS_RULES.PEACH_BLOSSOM[chart.day.branch] === p.branch, color: 'text-pink-500' }, 'Sky Horse': { rule: (p, chart) => SPECIAL_STARS_RULES.SKY_HORSE[chart.day.branch] === p.branch, color: 'text-yellow-400' }, 'Solitary Star': { rule: (p, chart) => SPECIAL_STARS_RULES.SOLITARY_STAR[chart.year.branch] === p.branch, color: 'text-gray-500' }, 'Red Matchmaker': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.RED_MATCHMAKER[chart.year.branch] === p.branch, color: 'text-pink-500' }, 'Red Chamber': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.RED_CHAMBER[chart.day.stem] === p.branch, color: 'text-pink-500' }, 'Gold Carriage': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.GOLD_CARRIAGE[chart.day.stem] === p.branch, color: 'text-yellow-500' }, 'Flying Blade': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.FLYING_BLADE[chart.year.branch] === p.branch, color: 'text-red-500' }, 'Litigation': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.LITIGATION[chart.year.branch] === p.branch, color: 'text-red-500' }, 'Cascading Clouds': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.CASCADING_CLOUDS[chart.day.stem] === p.branch, color: 'text-red-500' }, 'Study Hall': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.STUDY_HALL[chart.day.stem] === p.branch, color: 'text-blue-400' }, 'Sickness': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.SICKNESS(chart.year.branch) === p.branch, color: 'text-red-500' }, 'Five Ghost': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.FIVE_GHOST(chart.year.branch) === p.branch, color: 'text-red-500' }, 'Blood Knife': { rule: (p, chart) => { const frame = getBranchFrame(chart.year.branch); return frame && ADDITIONAL_SHEN_SHA_RULES_DEF.BLOOD_KNIFE[frame] === p.branch; }, color: 'text-red-500' }, 'Fortune Virtue': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.FORTUNE_VIRTUE[chart.year.stem] === p.branch, color: 'text-yellow-500' }, 'Golden Lock': { rule: (p, chart) => ADDITIONAL_SHEN_SHA_RULES_DEF.GOLDEN_LOCK[chart.year.stem] === p.branch, color: 'text-yellow-500' }, 'Grand Duke': { rule: (p, chart) => chart.liunian && chart.liunian.branch === p.branch, color: 'text-red-600 font-bold' }, 'Year Punishment': { rule: (p, chart) => chart.liunian && chart.liunian.branch && INTERACTIONS.PUNISHMENT.UNGRATEFUL[chart.liunian.branch] === p.branch, color: 'text-red-600 font-bold' }, 'Heavenly Virtue': { rule: (p, chart) => NEW_SHEN_SHA_RULES_DEF.TIAN_DE_STEM[chart.month.branch] === p.stem, color: 'text-green-500 font-semibold' }, 'Monthly Virtue': { rule: (p, chart) => { const frame = getBranchFrame(chart.month.branch); return frame && NEW_SHEN_SHA_RULES_DEF.YUE_DE_STEM[frame] === p.stem; }, color: 'text-green-500 font-semibold' }, 'General Star': { rule: (p, chart) => { const yearFrame = getBranchFrame(chart.year.branch); const dayFrame = getBranchFrame(chart.day.branch); return (yearFrame && NEW_SHEN_SHA_RULES_DEF.GENERAL_STAR[yearFrame] === p.branch) || (dayFrame && NEW_SHEN_SHA_RULES_DEF.GENERAL_STAR[dayFrame] === p.branch); }, color: 'text-yellow-400' }, 'Elegant Seal': { rule: (p, chart) => { const yearFrame = getBranchFrame(chart.year.branch); const dayFrame = getBranchFrame(chart.day.branch); return (yearFrame && NEW_SHEN_SHA_RULES_DEF.ELEGANT_SEAL[yearFrame] === p.branch) || (dayFrame && NEW_SHEN_SHA_RULES_DEF.ELEGANT_SEAL[dayFrame] === p.branch); }, color: 'text-blue-400' }, 'Robbery Sha': { rule: (p, chart) => { const yearFrame = getBranchFrame(chart.year.branch); const dayFrame = getBranchFrame(chart.day.branch); return (yearFrame && NEW_SHEN_SHA_RULES_DEF.ROBBERY_SHA[yearFrame] === p.branch) || (dayFrame && NEW_SHEN_SHA_RULES_DEF.ROBBERY_SHA[dayFrame] === p.branch); }, color: 'text-purple-600' }, 'Mourning Door': { rule: (p, chart) => NEW_SHEN_SHA_RULES_DEF.MOURNING_DOOR(chart.year.branch) === p.branch, color: 'text-purple-600' }, 'Separating Edge': { rule: (p, chart) => { const yearFrame = getBranchFrame(chart.year.branch); const dayFrame = getBranchFrame(chart.day.branch); return (yearFrame && NEW_SHEN_SHA_RULES_DEF.SEPARATING_EDGE[yearFrame] === p.branch) || (dayFrame && NEW_SHEN_SHA_RULES_DEF.SEPARATING_EDGE[dayFrame] === p.branch); }, color: 'text-purple-600' } };
        function calculateShenSha(pillars, chart) {
            const result = { 'Hour': [], 'Day': [], 'Month': [], 'Year': [] };
            pillars.forEach(p => {
                const pillarName = p.title;
                const pillarForCheck = { stem: p.stem.char, branch: p.branch.char };
                for (const shenShaName in SHEN_SHA_DATABASE) {
                    const shenSha = SHEN_SHA_DATABASE[shenShaName];
                    try {
                        if (shenSha.rule(pillarForCheck, chart)) { result[pillarName].push({ name: shenShaName, color: shenSha.color }); }
                    } catch (e) { console.error(`Error calculating Shen Sha "${shenShaName}" for pillar ${pillarName}:`, e); }
                }
            });
            for (const pillar in result) {
                const uniqueShenSha = []; const seenNames = new Set();
                for (const ss of result[pillar]) {
                    if (!seenNames.has(ss.name)) { uniqueShenSha.push(ss); seenNames.add(ss.name); }
                }
                result[pillar] = uniqueShenSha;
            }
            return result;
        }

        // --- DATA LAINNYA (MING GUA, DLL) ---
        const liChunDates = { 1900: [4, 1], 1901: [4, 1], 1902: [4, 1], 1903: [4, 1], 1904: [5, 1], 1905: [4, 1], 1906: [4, 1], 1907: [4, 1], 1908: [5, 1], 1909: [4, 1], 1910: [4, 1], 1911: [4, 1], 1912: [5, 1], 1913: [4, 1], 1914: [4, 1], 1915: [4, 1], 1916: [5, 1], 1917: [4, 1], 1918: [4, 1], 1919: [4, 1], 1920: [5, 1], 1921: [4, 1], 1922: [4, 1], 1923: [4, 1], 1924: [5, 1], 1925: [4, 1], 1926: [4, 1], 1927: [4, 1], 1928: [5, 1], 1929: [4, 1], 1930: [4, 1], 1931: [4, 1], 1932: [5, 1], 1933: [4, 1], 1934: [4, 1], 1935: [4, 1], 1936: [5, 1], 1937: [4, 1], 1938: [4, 1], 1939: [4, 1], 1940: [5, 1], 1941: [4, 1], 1942: [4, 1], 1943: [4, 1], 1944: [5, 1], 1945: [4, 1], 1946: [4, 1], 1947: [4, 1], 1948: [5, 1], 1949: [4, 1], 1950: [4, 1], 1951: [4, 1], 1952: [5, 1], 1953: [4, 1], 1954: [4, 1], 1955: [4, 1], 1956: [5, 1], 1957: [4, 1], 1958: [4, 1], 1959: [4, 1], 1960: [5, 1], 1961: [4, 1], 1962: [4, 1], 1963: [4, 1], 1964: [5, 1], 1965: [4, 1], 1966: [4, 1], 1967: [4, 1], 1968: [5, 1], 1969: [4, 1], 1970: [4, 1], 1971: [4, 1], 1972: [5, 1], 1973: [4, 1], 1974: [4, 1], 1975: [4, 1], 1976: [5, 1], 1977: [4, 1], 1978: [4, 1], 1979: [4, 1], 1980: [5, 1], 1981: [4, 1], 1982: [4, 1], 1983: [4, 1], 1984: [5, 1], 1985: [4, 1], 1986: [4, 1], 1987: [4, 1], 1988: [5, 1], 1989: [4, 1], 1990: [4, 1], 1991: [4, 1], 1992: [5, 1], 1993: [4, 1], 1994: [4, 1], 1995: [4, 1], 1996: [5, 1], 1997: [4, 1], 1998: [4, 1], 1999: [4, 1], 2000: [4, 1], 2001: [4, 1], 2002: [4, 1], 2003: [4, 1], 2004: [4, 1], 2005: [4, 1], 2006: [4, 1], 2007: [4, 1], 2008: [4, 1], 2009: [4, 1], 2010: [4, 1], 2011: [4, 1], 2012: [4, 1], 2013: [4, 1], 2014: [4, 1], 2015: [4, 1], 2016: [4, 1], 2017: [4, 1], 2018: [4, 1], 2019: [4, 1], 2020: [4, 1], 2021: [3, 1], 2022: [4, 1], 2023: [4, 1], 2024: [4, 1], 2025: [3, 1], 2026: [4, 1], 2027: [4, 1], 2028: [4, 1], 2029: [3, 1], 2030: [4, 1], 2031: [4, 1], 2032: [4, 1], 2033: [3, 1], 2034: [4, 1], 2035: [4, 1], 2036: [4, 1], 2037: [3, 1], 2038: [4, 1], 2039: [4, 1], 2040: [4, 1], 2041: [3, 1], 2042: [4, 1], 2043: [4, 1], 2044: [4, 1], 2045: [3, 1], 2046: [4, 1], 2047: [4, 1], 2048: [4, 1], 2049: [3, 1], 2050: [4, 1] };
        const baZhaiData = { 1: { group: 'East', best: { ShengQi: 'SE', TianYi: 'E', YanNian: 'S', FuWei: 'N' }, worst: { HuoHai: 'W', LiuSha: 'NW', WuGui: 'NE', JueMing: 'SW' } }, 2: { group: 'West', best: { ShengQi: 'NE', TianYi: 'W', YanNian: 'NW', FuWei: 'SW' }, worst: { HuoHai: 'E', LiuSha: 'SE', WuGui: 'S', JueMing: 'N' } }, 3: { group: 'East', best: { ShengQi: 'S', TianYi: 'N', YanNian: 'SE', FuWei: 'E' }, worst: { HuoHai: 'NW', LiuSha: 'W', WuGui: 'SW', JueMing: 'NE' } }, 4: { group: 'East', best: { ShengQi: 'E', TianYi: 'SE', YanNian: 'N', FuWei: 'S' }, worst: { HuoHai: 'NE', LiuSha: 'SW', WuGui: 'NW', JueMing: 'W' } }, 6: { group: 'West', best: { ShengQi: 'W', TianYi: 'NE', YanNian: 'SW', FuWei: 'NW' }, worst: { HuoHai: 'S', LiuSha: 'E', WuGui: 'SE', JueMing: 'N' } }, 7: { group: 'West', best: { ShengQi: 'NW', TianYi: 'SW', YanNian: 'W', FuWei: 'NE' }, worst: { HuoHai: 'N', LiuSha: 'S', WuGui: 'E', JueMing: 'SE' } }, 8: { group: 'West', best: { ShengQi: 'SW', TianYi: 'NW', YanNian: 'NE', FuWei: 'W' }, worst: { HuoHai: 'SE', LiuSha: 'N', WuGui: 'NW', JueMing: 'E' } }, 9: { group: 'East', best: { ShengQi: 'N', TianYi: 'S', YanNian: 'E', FuWei: 'SE' }, worst: { HuoHai: 'SW', LiuSha: 'NE', WuGui: 'W', JueMing: 'NW' } } };
        function calculateMingGua(birthYear, birthMonth, birthDay, gender) {
            let solarYear = birthYear;
            const liChunData = liChunDates[birthYear];
            if (liChunData) {
                const liChunDateObj = new Date(birthYear, liChunData[1], liChunData[0]);
                const birthDateObj = new Date(birthYear, birthMonth, birthDay);
                if (birthDateObj < liChunDateObj) { solarYear = birthYear - 1; }
            }
            let guaNumber;
            const lastTwoDigits = solarYear % 100;
            const sumOfDigits = (lastTwoDigits % 10) + Math.floor(lastTwoDigits / 10);
            const singleDigitSum = sumOfDigits % 9 === 0 ? 9 : sumOfDigits % 9;
            if (solarYear >= 2000) {
                if (gender === 'Pria') { guaNumber = (9 - singleDigitSum); if (guaNumber === 0) guaNumber = 9; } 
                else { guaNumber = (6 + singleDigitSum); if (guaNumber > 9) guaNumber = guaNumber % 9 === 0 ? 9 : guaNumber % 9; if (guaNumber === 0) guaNumber = 9; }
            } else {
                if (gender === 'Pria') { guaNumber = (10 - singleDigitSum); if (guaNumber === 0) guaNumber = 9; } 
                else { guaNumber = (5 + singleDigitSum); if (guaNumber > 9) guaNumber = guaNumber % 9 === 0 ? 9 : guaNumber % 9; if (guaNumber === 0) guaNumber = 9; }
            }
            if (guaNumber === 5) { guaNumber = (gender === 'Pria') ? 2 : 8; }
            return guaNumber;
        }
        function getBaZhaiDirections(mingGuaNumber) { return baZhaiData[mingGuaNumber] || null; }

        // --- ELEMEN DOM ---
        const birthDayInput = document.getElementById('birth-day'), birthMonthInput = document.getElementById('birth-month'), birthYearInput = document.getElementById('birth-year');
        const birthHourInput = document.getElementById('birth-hour'), birthMinuteInput = document.getElementById('birth-minute');
        const calculateBtn = document.getElementById('calculate-bazi-btn'), resetBtn = document.getElementById('reset-btn');
        const resultDiv = document.getElementById('bazi-chart-result'), luckPillarDiv = document.getElementById('luck-pillar-result'), annualPillarDiv = document.getElementById('annual-pillar-result');
        const elementStrengthDiv = document.getElementById('element-strength-result'), mingGuaBaZhaiResultDiv = document.getElementById('ming-gua-ba-zhai-result');
        const tenGodsDistributionDiv = document.getElementById('ten-gods-distribution-result'), genderSelect = document.getElementById('gender-select');
        const unknownHourCheckbox = document.getElementById('unknown-hour-checkbox'), timeContainer = document.getElementById('time-container');
        const analysisContextDiv = document.getElementById('analysis-context-div'), dynamicInteractionPanel = document.getElementById('dynamic-interaction-panel');
        const lifeAspectsDashboard = document.getElementById('life-aspects-dashboard');

        // --- FUNGSI TAMPILAN & KONTROL ---
        function populateDateSelectors() {
            const today = new Date(), currentYear = today.getFullYear(), currentMonth = today.getMonth(), currentDay = today.getDate();
            for (let i = 2100; i >= 1800; i--) { birthYearInput.innerHTML += `<option value="${i}">${i}</option>`; }
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            months.forEach((month, index) => { birthMonthInput.innerHTML += `<option value="${index}">${month}</option>`; });
            birthYearInput.value = currentYear; birthMonthInput.value = currentMonth;
            populateDaySelector(); birthDayInput.value = currentDay;
        }
        function populateDaySelector() {
            const year = parseInt(birthYearInput.value), month = parseInt(birthMonthInput.value);
            const daysInMonth = new Date(year, month + 1, 0).getDate(); const selectedDay = parseInt(birthDayInput.value);
            birthDayInput.innerHTML = ''; for (let i = 1; i <= daysInMonth; i++) { birthDayInput.innerHTML += `<option value="${i}">${i}</option>`; }
            if (selectedDay <= daysInMonth) { birthDayInput.value = selectedDay; }
        }
        function populateTimeSelectors() {
            const today = new Date();
            for (let i = 0; i < 24; i++) { const val = i.toString().padStart(2, '0'); birthHourInput.innerHTML += `<option value="${val}">${val}</option>`; }
            for (let i = 0; i < 60; i++) { const val = i.toString().padStart(2, '0'); birthMinuteInput.innerHTML += `<option value="${val}">${val}</option>`; }
            birthHourInput.value = today.getHours().toString().padStart(2, '0'); birthMinuteInput.value = today.getMinutes().toString().padStart(2, '0');
        }
        function getTenGods(dayMaster, otherStemOrBranch) {
            if (!dayMaster || !otherStemOrBranch) return '';
            const polarityRelation = dayMaster.polarity === otherStemOrBranch.polarity ? 'same' : 'diff';
            return tenGods[dayMaster.element][otherStemOrBranch.element][polarityRelation];
        }
        function resetForm() {
            populateDateSelectors(); populateTimeSelectors();
            genderSelect.value = 'Pria';
            unknownHourCheckbox.checked = false;
            unknownHourCheckbox.dispatchEvent(new Event('change'));
            resultDiv.innerHTML = '<p class="text-center text-gray-400">Hasil Bazi Chart akan ditampilkan di sini.</p>';
            luckPillarDiv.innerHTML = '';
            annualPillarDiv.innerHTML = '';
            elementStrengthDiv.innerHTML = '';
            mingGuaBaZhaiResultDiv.innerHTML = '';
            tenGodsDistributionDiv.innerHTML = '';
            analysisContextDiv.innerHTML = '';
            dynamicInteractionPanel.innerHTML = '';
            lifeAspectsDashboard.innerHTML = '';
            natalChartData = null;
            selectedDayun = null;
            selectedLiunian = null;
            natalLifeAspects = null;
        }

        // --- FUNGSI KALKULATOR BAZI UTAMA ---
        function calculateBaziChart() {
            const year = parseInt(birthYearInput.value), month = parseInt(birthMonthInput.value), day = parseInt(birthDayInput.value);
            const hour = parseInt(birthHourInput.value), gender = genderSelect.value, isHourUnknown = unknownHourCheckbox.checked;
            
            const baziYear = (month < 1 || (month === 1 && day < 5)) ? year - 1 : year;
            const yearStemIndex = ((baziYear - 1924) % 10 + 10) % 10, yearBranchIndex = ((baziYear - 1924) % 12 + 12) % 12;
            let baziGregorianMonth = month;
            if (day < solarMonthStartDates[month]) { baziGregorianMonth = (month - 1 + 12) % 12; }
            const gregorianToSolarOrderMap = [11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const gregorianToBranchIndexMap = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 0];
            let firstMonthStemIndex;
            switch (yearStemIndex) {
                case 0: case 5: firstMonthStemIndex = 2; break; case 1: case 6: firstMonthStemIndex = 4; break;
                case 2: case 7: firstMonthStemIndex = 6; break; case 3: case 8: firstMonthStemIndex = 8; break;
                case 4: case 9: firstMonthStemIndex = 0; break;
            }
            const solarMonthOrder = gregorianToSolarOrderMap[baziGregorianMonth];
            const monthStemIndex = (firstMonthStemIndex + solarMonthOrder) % 10, monthBranchIndex = gregorianToBranchIndexMap[baziGregorianMonth];
            const refDate = new Date('1924-01-01T00:00:00Z'), targetDate = new Date(Date.UTC(year, month, day));
            const dayDiff = Math.floor((targetDate.getTime() - refDate.getTime()) / (1000 * 60 * 60 * 24));
            const dayGanzhiIndex = ((dayDiff + 15) % 60 + 60) % 60;
            const dayStemIndex = dayGanzhiIndex % 10, dayBranchIndex = dayGanzhiIndex % 12;
            const dayMaster = heavenlyStems[dayStemIndex];
            
            let pillars = [], hourStemIndex, hourBranchIndex;
            if (isHourUnknown) {
                pillars = [
                    { title: 'Day', stem: dayMaster, branch: earthlyBranches[dayBranchIndex], branchIndex: dayBranchIndex },
                    { title: 'Month', stem: heavenlyStems[monthStemIndex], branch: earthlyBranches[monthBranchIndex], branchIndex: monthBranchIndex },
                    { title: 'Year', stem: heavenlyStems[yearStemIndex], branch: earthlyBranches[yearBranchIndex], branchIndex: yearBranchIndex }
                ];
            } else {
                const dayStemForHourCalc = (hour >= 23) ? (dayStemIndex + 1) % 10 : dayStemIndex;
                const ziHourStemIndex = [0, 2, 4, 6, 8, 0, 2, 4, 6, 8][dayStemForHourCalc];
                hourBranchIndex = Math.floor((hour + 1) / 2) % 12;
                hourStemIndex = (ziHourStemIndex + hourBranchIndex) % 10;
                pillars = [
                    { title: 'Hour', stem: heavenlyStems[hourStemIndex], branch: earthlyBranches[hourBranchIndex], branchIndex: hourBranchIndex },
                    { title: 'Day', stem: dayMaster, branch: earthlyBranches[dayBranchIndex], branchIndex: dayBranchIndex },
                    { title: 'Month', stem: heavenlyStems[monthStemIndex], branch: earthlyBranches[monthBranchIndex], branchIndex: monthBranchIndex },
                    { title: 'Year', stem: heavenlyStems[yearStemIndex], branch: earthlyBranches[yearBranchIndex], branchIndex: yearBranchIndex }
                ];
            }
            
            const luckPillarsData = calculateLuckPillars(year, month, day, yearStemIndex, monthStemIndex, monthBranchIndex, gender);

            natalChartData = {
                pillars: pillars,
                dayMaster: dayMaster,
                dayMasterStemIndex: dayStemIndex,
                gender: gender,
                isHourUnknown: isHourUnknown,
                birthYear: year,
                luckPillars: luckPillarsData.luckPillars,
                luckPillarStartAge: luckPillarsData.startAge,
                luckPillarDirection: luckPillarsData.direction,
            };

            displayBaziChart(pillars, dayMaster, dayStemIndex, calculateShenSha(pillars, getChartForShenSha()));
            displayLuckPillars(natalChartData.luckPillars, dayMaster, natalChartData.luckPillarDirection, natalChartData.luckPillarStartAge, dayStemIndex, isHourUnknown, year, month, day);
            runFullAnalysis(pillars, dayMaster, isHourUnknown, gender);
            const mingGuaResult = calculateMingGua(year, month, day, gender);
            const baZhaiResult = getBaZhaiDirections(mingGuaResult);
            displayMingGuaAndBaZhai(mingGuaResult, baZhaiResult);
        }
        
        function getChartForShenSha() {
            if (!natalChartData) return {};
            const chart = {};
            natalChartData.pillars.forEach(p => {
                chart[p.title.toLowerCase()] = { stem: p.stem.char, branch: p.branch.char };
            });
            const liunianYear = selectedLiunian ? selectedLiunian.year : new Date().getFullYear();
            const liunianStemIndex = ((liunianYear - 1924) % 10 + 10) % 10;
            const liunianBranchIndex = ((liunianYear - 1924) % 12 + 12) % 12;
            chart.liunian = { stem: heavenlyStems[liunianStemIndex].char, branch: earthlyBranches[liunianBranchIndex].char };
            return chart;
        }

        function runFullAnalysis(pillarsForAnalysis, dayMaster, isHourUnknown, gender, contextTitle = "Analisis Bagan Kelahiran (Natal Chart)") {
            displayAnalysisContext(contextTitle);
            detectAndDisplayDynamicInteractions(natalChartData.pillars, selectedDayun, selectedLiunian);
            
            const analysisResult = analyzeElementStrength(pillarsForAnalysis, dayMaster, isHourUnknown);
            const tenGodsScores = calculate10GodsDistribution(pillarsForAnalysis, dayMaster);
            
            const currentLifeAspects = calculateLifeAspects(tenGodsScores, analysisResult.favorable, analysisResult.unfavorable, gender, dayMaster);

            if (contextTitle === "Analisis Bagan Kelahiran (Natal Chart)") {
                natalLifeAspects = currentLifeAspects;
            }
            
            displayLifeAspectsDashboard(natalLifeAspects, currentLifeAspects);
            displayElementStrength(analysisResult.finalScores, dayMaster.element, analysisResult.dayMasterStrengthStatus, isHourUnknown, analysisResult.notes, analysisResult.specialChartType);
            display10GodsDistribution(tenGodsScores);
        }

        // --- MESIN ANALISIS KEKUATAN & INTERAKSI ---
        const interactionData = {
            threeHarmony: [ { combo: ['申', '子', '辰'], element: 'Water', icon: '💧' }, { combo: ['亥', '卯', '未'], element: 'Wood', icon: '🌳' }, { combo: ['寅', '午', '戌'], element: 'Fire', icon: '🔥' }, { combo: ['巳', '酉', '丑'], element: 'Metal', icon: '⚙️' } ],
            sixHarmony: [ { combo: ['子', '丑'], element: 'Earth', icon: '🌍' }, { combo: ['寅', '亥'], element: 'Wood', icon: '🌳' }, { combo: ['卯', '戌'], element: 'Fire', icon: '🔥' }, { combo: ['辰', '酉'], element: 'Metal', icon: '⚙️' }, { combo: ['巳', '申'], element: 'Water', icon: '💧' }, { combo: ['午', '未'], element: 'Fire', icon: '🔥' } ],
            clash: { '子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥' }
        };
        function findInteractions(pillars, notes) {
            const scoreModifiers = { 'Wood': 0, 'Fire': 0, 'Earth': 0, 'Metal': 0, 'Water': 0 };
            const branches = pillars.map(p => p.branch.char);
            interactionData.threeHarmony.forEach(harmony => {
                const presentBranches = harmony.combo.filter(b => branches.includes(b));
                if (presentBranches.length === 3) {
                    notes.push(`Full Three Harmony: ${harmony.combo.join(', ')} forms strong ${harmony.element}.`);
                    scoreModifiers[harmony.element] += 40;
                } else if (presentBranches.length === 2) {
                    let isSemiHarmony = false;
                    const [b1, b2, b3] = harmony.combo; 
                    if ((presentBranches.includes(b1) && presentBranches.includes(b2)) || (presentBranches.includes(b2) && presentBranches.includes(b3))) { isSemiHarmony = true; }
                    if (isSemiHarmony) {
                        notes.push(`Semi-Harmony: ${presentBranches.join(', ')} forms a partial ${harmony.element} combination.`);
                        scoreModifiers[harmony.element] += 15; 
                    }
                }
            });
            for (let i = 0; i < pillars.length; i++) {
                for (let j = i + 1; j < pillars.length; j++) {
                    const b1 = pillars[i].branch.char, b2 = pillars[j].branch.char;
                    interactionData.sixHarmony.forEach(harmony => {
                        if ((harmony.combo[0] === b1 && harmony.combo[1] === b2) || (harmony.combo[0] === b2 && harmony.combo[1] === b1)) {
                            notes.push(`Six Harmony: ${b1} and ${b2} combine, strengthening ${harmony.element}.`);
                            scoreModifiers[harmony.element] += 20;
                        }
                    });
                }
            }
            const processedClashes = new Set();
            for (let i = 0; i < pillars.length; i++) {
                for (let j = i + 1; j < pillars.length; j++) {
                    const b1 = pillars[i].branch, b2 = pillars[j].branch;
                    const clashPair1 = `${b1.char}-${b2.char}`, clashPair2 = `${b2.char}-${b1.char}`;
                    if (interactionData.clash[b1.char] === b2.char && !processedClashes.has(clashPair1) && !processedClashes.has(clashPair2)) {
                        notes.push(`Clash: ${b1.char} (${b1.animal}) clashes with ${b2.char} (${b2.animal}).`);
                        scoreModifiers[b1.element] -= 15; scoreModifiers[b2.element] -= 15;
                        processedClashes.add(clashPair1);
                    }
                }
            }
            return scoreModifiers;
        }
        function classifyDayMasterStrength(finalScores, dmElement, dayMaster, pillars, supportScore, weakeningScore, resourceElement, outputElement, wealthElement, powerElement) {
            let dayMasterStrengthStatus = '', specialChartType = '';
            const hasStrongRoot = (stemElement, branchChar) => {
                const hiddenStems = hiddenStemsData[branchChar];
                if (!hiddenStems || hiddenStems.length === 0) return false;
                return heavenlyStems[hiddenStems[0]].element === stemElement;
            };
            const dmHasStrongRootInChart = pillars.some(p => p.stem.element === dmElement && hasStrongRoot(dmElement, p.branch.char));
            if (supportScore < 25 && !dmHasStrongRootInChart) { 
                let dominantElement = null, maxDominantScore = 0;
                const elementsToConsiderForFollow = [outputElement, wealthElement, powerElement];
                for (const elem of elementsToConsiderForFollow) {
                    if (finalScores[elem] > maxDominantScore) { maxDominantScore = finalScores[elem]; dominantElement = elem; }
                }
                if (dominantElement && maxDominantScore > 80) { 
                    if (dominantElement === wealthElement && finalScores[resourceElement] < 10 && finalScores[powerElement] < 30) { specialChartType = '從財格 (Follow the Wealth)'; dayMasterStrengthStatus = 'Sangat Lemah (Bagan Spesial)'; } 
                    else if (dominantElement === powerElement && finalScores[outputElement] < 10) { specialChartType = '從殺格 / 從官格 (Follow the Power)'; dayMasterStrengthStatus = 'Sangat Lemah (Bagan Spesial)'; } 
                    else if (dominantElement === outputElement && finalScores[resourceElement] < 5) { specialChartType = '從兒格 (Follow the Child)'; dayMasterStrengthStatus = 'Sangat Lemah (Bagan Spesial)'; }
                }
            }
            if (!specialChartType && supportScore > 100 && weakeningScore < 30 && dmHasStrongRootInChart) { 
                const totalStrengthOfDMAndResource = finalScores[dmElement] + finalScores[resourceElement];
                const totalChartScore = Object.values(finalScores).reduce((sum, score) => sum + score, 0);
                if (totalChartScore > 0 && (totalStrengthOfDMAndResource / totalChartScore) > 0.75 && finalScores[powerElement] < 10) { 
                    switch (dmElement) {
                        case 'Wood': specialChartType = '曲直格 (Bending and Straightening)'; break; case 'Fire': specialChartType = '炎上格 (Flame Upwards)'; break;
                        case 'Earth': specialChartType = '稼穡格 (Sowing and Reaping)'; break; case 'Metal': specialChartType = '從革格 (Revolution)'; break;
                        case 'Water': specialChartType = '潤下格 (Moistening Downwards)'; break;
                    }
                    dayMasterStrengthStatus = 'Sangat Kuat (Bagan Spesial)'; 
                }
            }
            if (!specialChartType) {
                const totalRelevantScore = supportScore + weakeningScore;
                if (totalRelevantScore === 0) { dayMasterStrengthStatus = 'Tidak Terdefinisi (Data Kurang)'; } 
                else {
                    const ratio = supportScore / weakeningScore; 
                    if (ratio > 2.5) { dayMasterStrengthStatus = 'Sangat Kuat'; } else if (ratio > 1.5) { dayMasterStrengthStatus = 'Kuat'; } 
                    else if (ratio > 1.05) { dayMasterStrengthStatus = 'Agak Kuat'; } else if (ratio >= 0.95 && ratio <= 1.05) { dayMasterStrengthStatus = 'Seimbang'; } 
                    else if (ratio < 0.4) { dayMasterStrengthStatus = 'Sangat Lemah'; } else if (ratio < 0.65) { dayMasterStrengthStatus = 'Lemah'; } 
                    else { dayMasterStrengthStatus = 'Cenderung Lemah'; }
                }
            }
            return { dayMasterStrengthStatus, specialChartType };
        }
        function analyzeElementStrength(pillars, dayMaster, isHourUnknown) {
            let baseScores = { 'Wood': 0, 'Fire': 0, 'Earth': 0, 'Metal': 0, 'Water': 0 };
            const monthBranch = pillars.find(p => p.title === 'Month').branch;
            baseScores[monthBranch.element] += 40; 
            pillars.forEach(p => {
                const isDayun = p.title === 'Dayun', isLiunian = p.title === 'Liunian';
                let stemWeight = 7, branchWeight = 10;
                if(isDayun) { stemWeight = 12; branchWeight = 18; }
                if(isLiunian) { stemWeight = 10; branchWeight = 15; }
                baseScores[p.stem.element] += stemWeight;
                baseScores[p.branch.element] += branchWeight;
                if (p.stem.element === p.branch.element) { baseScores[p.stem.element] += 15; }
                const hidden = hiddenStemsData[p.branch.char];
                hidden.forEach((hsIndex, index) => {
                    const stemData = heavenlyStems[hsIndex];
                    if (stemData) { 
                        const hsElement = heavenlyStems[hsIndex].element;
                        if(p.stem.element === hsElement) {
                            if (index === 0) { baseScores[p.stem.element] += 15; } else { baseScores[p.stem.element] += 8; }
                        }
                        baseScores[hsElement] += (index === 0) ? 5 : 3; 
                    }
                });
            });
            let notes = [];
            const interactionModifiers = findInteractions(pillars, notes);
            for (const element in baseScores) { baseScores[element] += interactionModifiers[element]; }
            let finalScores = {...baseScores};
            const productionFactor = 0.4, weakeningFactor = 0.2;  
            elementCycle.forEach((producer, i) => {
                const produced = elementCycle[(i + 1) % 5];
                const productionBonus = baseScores[producer] * productionFactor;
                if (productionBonus > 1) { 
                    finalScores[produced] += productionBonus;
                    finalScores[producer] -= baseScores[producer] * weakeningFactor;
                }
            });
            for (const element in finalScores) { if (finalScores[element] < 0) finalScores[element] = 0; }
            const dmElement = dayMaster.element;
            const resourceElement = elementCycle[(elementCycle.indexOf(dmElement) + 4) % 5];
            const outputElement = elementCycle[(elementCycle.indexOf(dmElement) + 1) % 5];
            const wealthElement = elementCycle[(elementCycle.indexOf(dmElement) + 2) % 5];
            const powerElement = elementCycle[(elementCycle.indexOf(dmElement) + 3) % 5];
            const supportScore = finalScores[dmElement] + finalScores[resourceElement];
            const weakeningScore = finalScores[outputElement] + finalScores[wealthElement] + finalScores[powerElement];
            const { dayMasterStrengthStatus, specialChartType } = classifyDayMasterStrength(finalScores, dmElement, dayMaster, pillars, supportScore, weakeningScore, resourceElement, outputElement, wealthElement, powerElement);
            
            let favorable, unfavorable;
            if (dayMasterStrengthStatus.includes('Kuat') || dayMasterStrengthStatus.includes('Seimbang') || specialChartType.includes('旺格')) {
                favorable = [outputElement, wealthElement, powerElement]; unfavorable = [dmElement, resourceElement];
            } else { 
                favorable = [dmElement, resourceElement]; unfavorable = [outputElement, wealthElement, powerElement];
            }

            return { finalScores, dayMasterStrengthStatus, specialChartType, notes, favorable, unfavorable };
        }
        function calculate10GodsDistribution(pillars, dayMaster) {
            const tenGodsInfluence = { 'Friend': 0, 'Rob Wealth': 0, 'Eating God': 0, 'Hurting Officer': 0, 'Direct Wealth': 0, 'Indirect Wealth': 0, 'Direct Officer': 0, '7 Killings': 0, 'Direct Resource': 0, 'Indirect Resource': 0 };
            const dmElement = dayMaster.element, dmPolarity = dayMaster.polarity;
            const monthBranchElement = pillars.find(p => p.title === 'Month').branch.element;
            const get10GodName = (dmElem, dmPol, otherElem, otherPol) => {
                const polarityRelation = dmPol === otherPol ? 'same' : 'diff';
                const tenGodCode = tenGods[dmElem][otherElem][polarityRelation];
                switch(tenGodCode) {
                    case 'F': return 'Friend'; case 'RW': return 'Rob Wealth'; case 'EG': return 'Eating God'; case 'HO': return 'Hurting Officer';
                    case 'DW': return 'Direct Wealth'; case 'IW': return 'Indirect Wealth'; case 'DO': return 'Direct Officer'; case '7K': return '7 Killings';
                    case 'DR': return 'Direct Resource'; case 'IR': return 'Indirect Resource'; default: return ''; 
                }
            };
            pillars.forEach(p => {
                const isDayun = p.title === 'Dayun', isLiunian = p.title === 'Liunian';
                let weight = 10;
                if(isDayun) weight = 15;
                if(isLiunian) weight = 12;

                if (p.title !== 'Day') {
                    const tenGodName = get10GodName(dmElement, dmPolarity, p.stem.element, p.stem.polarity);
                    if (tenGodName) {
                        tenGodsInfluence[tenGodName] += weight;
                        if (p.stem.element === monthBranchElement) { tenGodsInfluence[tenGodName] += 5; }
                    }
                }
                const hidden = hiddenStemsData[p.branch.char];
                hidden.forEach((hsIndex, index) => {
                    const hiddenStemData = heavenlyStems[hsIndex];
                    const tenGodName = get10GodName(dmElement, dmPolarity, hiddenStemData.element, hiddenStemData.polarity);
                    if (tenGodName) {
                        let hiddenWeight = (index === 0) ? 8 : 4;
                        if(isDayun) hiddenWeight = (index === 0) ? 12 : 6;
                        if(isLiunian) hiddenWeight = (index === 0) ? 10 : 5;
                        tenGodsInfluence[tenGodName] += hiddenWeight;
                        if (p.branch.element === monthBranchElement) { tenGodsInfluence[tenGodName] += (index === 0) ? 3 : 1; }
                    }
                });
            });
            const dmTenGodName = get10GodName(dmElement, dmPolarity, dmElement, dmPolarity);
            if (dmTenGodName) { tenGodsInfluence[dmTenGodName] += 20; }
            let sorted10Gods = Object.keys(tenGodsInfluence).map(name => ({ name: name, score: tenGodsInfluence[name] }));
            sorted10Gods.sort((a, b) => b.score - a.score);
            return sorted10Gods;
        }

        // --- FUNGSI TAMPILAN ---
        function displayBaziChart(pillars, dayMaster, dayMasterStemIndex, shenShaResults) {
            let headerHtml = '', heavenlyStemHtml = '', earthlyBranchHtml = '', hiddenStemHtml = '', qiStageHtml = '', shenShaHtml = '';
            pillars.forEach(p => {
                headerHtml += `<th class="p-2 border-l border-gray-700 text-center font-normal"><p class="text-sm text-gray-400">${p.title}</p></th>`;
                const tenGod = p.title === 'Day' ? 'DM' : getTenGods(dayMaster, p.stem);
                heavenlyStemHtml += `<td class="p-4 border-l border-gray-700 text-center"><div class="flex items-start justify-center gap-2"><p class="text-4xl">${p.stem.char}</p><div class="text-left"><span class="text-xs font-bold bg-gray-600 px-1 rounded">${tenGod}</span><span class="block w-4 h-4 rounded-full ${elementColors[p.stem.element]} mt-1"></span></div></div><p class="font-semibold">${p.stem.pinyin}</p><p class="text-sm text-gray-400">${p.stem.polarity} ${p.stem.element}</p></td>`;
                earthlyBranchHtml += `<td class="p-4 border-l border-gray-700 text-center"><div class="flex items-center justify-center gap-2"><p class="text-4xl">${p.branch.char}</p><span class="w-4 h-4 rounded-full ${elementColors[p.branch.element]}"></span></div><p class="font-semibold">${p.branch.pinyin}</p><p class="text-sm text-gray-400">${p.branch.animal}</p></td>`;
                let hiddenContent = '<div class="flex flex-wrap items-center justify-center gap-2">';
                hiddenStemsData[p.branch.char].forEach(hsIndex => {
                    const stemData = heavenlyStems[hsIndex];
                    if (stemData) { hiddenContent += `<div class="text-center"><span class="text-xs font-bold bg-gray-600 px-1 rounded">${getTenGods(dayMaster, stemData)}</span><p class="text-xl mt-1">${stemData.char}</p></div>`; }
                });
                hiddenStemHtml += `<td class="p-4 border-l border-gray-700 text-center">${hiddenContent}</div></td>`;
                qiStageHtml += `<td class="p-4 border-l border-gray-700 text-center text-sm text-gray-400">${get12QiStage(dayMasterStemIndex, p.branch.index)}</td>`;
                const pillarShenSha = shenShaResults[p.title] || [];
                shenShaHtml += `<td class="p-2 border-l border-gray-700 text-center shen-sha-list">${pillarShenSha.length > 0 ? pillarShenSha.map(ss => `<span class="shen-sha-item ${ss.color}">${ss.name}</span>`).join('') : '-'}</td>`;
            });
            resultDiv.innerHTML = `<div class="custom-scrollbar overflow-x-auto bg-gray-800 rounded-lg p-1"><table class="w-full min-w-[${pillars.length === 3 ? '450px' : '600px'}] border-collapse"><thead><tr class="bg-gray-700/50"><th class="p-2 text-center w-32">Pillar</th>${headerHtml}</tr></thead><tbody><tr class="border-t border-gray-700"><th class="p-4 text-left bg-gray-700/50">Heavenly Stem</th>${heavenlyStemHtml}</tr><tr class="border-t border-gray-700"><th class="p-4 text-left bg-gray-700/50">Earthly Branch</th>${earthlyBranchHtml}</tr><tr class="border-t border-gray-700"><th class="p-4 text-left bg-gray-700/50">Hidden Stem</th>${hiddenStemHtml}</tr><tr class="border-t border-gray-700"><th class="p-4 text-left bg-gray-700/50">12 Qi Stage</th>${qiStageHtml}</tr><tr class="border-t border-gray-700"><th class="p-4 text-left bg-gray-700/50">Shen Sha</th>${shenShaHtml}</tr></tbody></table></div>`;
        }
        function calculateLuckPillars(birthYear, birthMonth, birthDay, yearStemIndex, monthStemIndex, monthBranchIndex, gender) {
            const yearStem = heavenlyStems[yearStemIndex];
            const direction = (yearStem.polarity === 'Yang' && gender === 'Pria') || (yearStem.polarity === 'Yin' && gender === 'Wanita') ? 1 : -1;
            const birthDate = new Date(birthYear, birthMonth, birthDay);
            let daysToNextTerm = 0, daysFromPrevTerm = 0;
            const currentMonthStartDate = new Date(birthYear, birthMonth, solarMonthStartDates[birthMonth]);
            if (birthDate < currentMonthStartDate) {
                const prevMonth = (birthMonth - 1 + 12) % 12, prevMonthYear = (birthMonth === 0) ? birthYear - 1 : birthYear;
                const prevMonthStartDate = new Date(prevMonthYear, prevMonth, solarMonthStartDates[prevMonth]);
                daysToNextTerm = Math.round((currentMonthStartDate - birthDate) / 86400000);
                daysFromPrevTerm = Math.round((birthDate - prevMonthStartDate) / 86400000);
            } else {
                const nextMonth = (birthMonth + 1) % 12, nextMonthYear = (birthMonth === 11) ? birthYear + 1 : birthYear;
                const nextMonthStartDate = new Date(nextMonthYear, nextMonth, solarMonthStartDates[nextMonth]);
                daysToNextTerm = Math.round((nextMonthStartDate - birthDate) / 86400000);
                daysFromPrevTerm = Math.round((birthDate - currentMonthStartDate) / 86400000);
            }
            const daysDiff = (direction === 1) ? daysToNextTerm : daysFromPrevTerm;
            const startAge = Math.floor(daysDiff / 3);
            let luckPillars = [];
            for (let i = 0; i < 10; i++) {
                const ageStart = startAge + (i * 10);
                const currentStemIndex = (monthStemIndex + ((i + 1) * direction) + 600) % 10;
                const currentBranchIndex = (monthBranchIndex + ((i + 1) * direction) + 600) % 12;
                luckPillars.push({ ageRange: `${ageStart} - ${ageStart + 9}`, stem: heavenlyStems[currentStemIndex], branch: earthlyBranches[currentBranchIndex] });
            }
            return { luckPillars, startAge, direction };
        }
        function displayLuckPillars(luckPillars, dayMaster, direction, startAge, dayMasterStemIndex, isHourUnknown, birthYear, birthMonth, birthDay) {
            const disclaimer = isHourUnknown ? `<div class="bg-yellow-900/50 border border-yellow-700 text-yellow-300 text-xs rounded-lg p-3 mb-4"><strong>Peringatan:</strong> Analisis tidak lengkap. Karena jam lahir tidak diketahui, interaksi dengan Pilar Jam tidak dapat dihitung. Pilar ini ditampilkan sebagai referensi.</div>` : '';
            let pillarsHtml = '';
            const today = new Date(), currentYear = today.getFullYear(), currentMonth = today.getMonth(), currentDay = today.getDate();
            let currentAge = currentYear - birthYear;
            if (currentMonth < birthMonth || (currentMonth === birthMonth && currentDay < birthDay)) { currentAge--; }
            luckPillars.forEach(p => {
                const ageStartPillar = parseInt(p.ageRange.split(' - ')[0]), ageEndPillar = parseInt(p.ageRange.split(' - ')[1]);
                let highlightClass = (currentAge >= ageStartPillar && currentAge <= ageEndPillar) ? 'current-dayun-highlight' : '';
                pillarsHtml += `<div class="pillar-card dayun-pillar-card ${highlightClass}" data-stem-index="${p.stem.index}" data-branch-index="${p.branch.index}" data-age-range="${p.ageRange}">
                    <p class="text-sm font-semibold text-gray-400 mb-2">Usia: ${p.ageRange}</p>
                    <div class="flex items-start justify-center gap-2 mb-2"><p class="text-3xl font-bold">${p.stem.char}</p><div class="text-left"><span class="text-xs font-bold bg-gray-600 px-1 rounded">${getTenGods(dayMaster, p.stem)}</span><span class="element-dot ${elementColors[p.stem.element]}"></span></div></div>
                    <p class="text-sm text-gray-300">${p.stem.pinyin} ${p.stem.polarity} ${p.stem.element}</p>
                    <div class="flex items-start justify-center gap-2 mt-4"><p class="text-3xl font-bold">${p.branch.char}</p><div class="text-left"><span class="text-xs font-bold bg-gray-600 px-1 rounded">${getTenGods(dayMaster, p.branch)}</span><span class="element-dot ${elementColors[p.branch.element]}"></span></div></div>
                    <p class="text-sm text-gray-300">${p.branch.pinyin} ${p.branch.animal}</p>
                    <p class="text-xs text-blue-400 mt-2">${get12QiStage(dayMasterStemIndex, p.branch.index)}</p>
                </div>`;
            });
            luckPillarDiv.innerHTML = `<div class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6"><h2 class="text-xl font-bold text-white mb-4">Siklus Keberuntungan (大运)</h2><p class="text-sm text-gray-400 mb-4">Klik pada pilar di bawah untuk melihat pengaruhnya terhadap bagan kelahiran Anda.</p>${disclaimer}<div class="text-sm text-gray-400 mb-4"><p>Arah: <span class="font-semibold text-white">${direction === 1 ? 'Maju (順行)' : 'Mundur (逆行)'}</span> | Usia Mulai: <span class="font-semibold text-white">~${startAge}</span></p></div><div class="custom-scrollbar overflow-x-auto py-4"><div class="flex space-x-4 min-w-max pb-2">${pillarsHtml}</div></div></div>`;
        }
        function displayAnnualPillars(dayunAgeRange) {
            if (!natalChartData) return;
            const startAge = parseInt(dayunAgeRange.split(' - ')[0]);
            const birthYear = natalChartData.birthYear;
            const dayMaster = natalChartData.dayMaster;
            const dayMasterStemIndex = natalChartData.dayMasterStemIndex;
            let pillarsHtml = '';

            for (let i = 0; i < 10; i++) {
                const currentYear = birthYear + startAge + i;
                const yearStemIndex = ((currentYear - 1924) % 10 + 10) % 10;
                const yearBranchIndex = ((currentYear - 1924) % 12 + 12) % 12;
                const stem = heavenlyStems[yearStemIndex];
                const branch = earthlyBranches[yearBranchIndex];
                
                pillarsHtml += `<div class="pillar-card liunian-pillar-card" data-year="${currentYear}" data-stem-index="${stem.index}" data-branch-index="${branch.index}">
                    <p class="text-sm font-semibold text-gray-400 mb-2">Tahun: ${currentYear}</p>
                    <div class="flex items-start justify-center gap-2 mb-2"><p class="text-3xl font-bold">${stem.char}</p><div class="text-left"><span class="text-xs font-bold bg-gray-600 px-1 rounded">${getTenGods(dayMaster, stem)}</span><span class="element-dot ${elementColors[stem.element]}"></span></div></div>
                    <p class="text-sm text-gray-300">${stem.pinyin}</p>
                    <div class="flex items-start justify-center gap-2 mt-4"><p class="text-3xl font-bold">${branch.char}</p><div class="text-left"><span class="text-xs font-bold bg-gray-600 px-1 rounded">${getTenGods(dayMaster, branch)}</span><span class="element-dot ${elementColors[branch.element]}"></span></div></div>
                    <p class="text-sm text-gray-300">${branch.pinyin}</p>
                    <p class="text-xs text-blue-400 mt-2">${get12QiStage(dayMasterStemIndex, branch.index)}</p>
                </div>`;
            }
            annualPillarDiv.innerHTML = `<div class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6 mt-8"><h2 class="text-xl font-bold text-white mb-4">Pilar Tahunan (流年) dalam Siklus ${dayunAgeRange}</h2><p class="text-sm text-gray-400 mb-4">Klik pilar tahunan untuk analisis yang lebih spesifik.</p><div class="custom-scrollbar overflow-x-auto py-4"><div class="flex space-x-4 min-w-max pb-2">${pillarsHtml}</div></div></div>`;
        }
        function displayAnalysisContext(title) {
            if (!title || title === "Analisis Bagan Kelahiran (Natal Chart)") {
                analysisContextDiv.innerHTML = ''; return;
            }
            analysisContextDiv.innerHTML = `<div class="bg-blue-900/30 border border-blue-700 text-blue-200 rounded-lg p-4 max-w-4xl mx-auto flex justify-between items-center"><div class="flex-grow"><h3 class="font-bold">${title}</h3><p class="text-sm text-blue-300">Semua analisis di bawah ini telah disesuaikan dengan pengaruh sementara yang dipilih.</p></div><button id="reset-analysis-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-4 flex-shrink-0">Reset ke Natal</button></div>`;
            document.getElementById('reset-analysis-btn').addEventListener('click', resetToNatalAnalysis);
        }
        function displayElementStrength(scores, dmElement, dayMasterStrengthStatus, isHourUnknown, interactionNotes, specialChartType) {
            const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
            let chartHtml = '';
            elementCycle.forEach(element => {
                const percentage = totalScore > 0 ? (scores[element] / totalScore * 100).toFixed(1) : 0;
                chartHtml += `<div class="flex items-center mb-2"><div class="w-16 text-sm text-gray-300">${element}</div><div class="flex-1 bg-gray-700 rounded-full h-5"><div class="chart-bar ${elementColors[element]} h-5 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: ${percentage}%">${percentage}%</div></div></div>`;
            });
            let summaryHtml;
            if(isHourUnknown) {
                summaryHtml = `<h3 class="font-semibold text-white mb-3">Analisis Parsial (Tanpa Jam Lahir)</h3><div class="text-sm space-y-3 p-4 bg-gray-900/50 rounded-lg"><p>Kekuatan Day Master cenderung <span class="font-bold ${dayMasterStrengthStatus.includes('Kuat') ? 'text-green-400' : (dayMasterStrengthStatus.includes('Lemah') ? 'text-red-400' : 'text-yellow-400')}">${dayMasterStrengthStatus}</span>.</p><p class="text-yellow-400"><strong class="block">Penting:</strong> Analisis Favorable/Unfavorable Elements baru bisa dipastikan setelah Jam Lahir diketahui.</p></div>`;
            } else {
                 const resourceElement = elementCycle[(elementCycle.indexOf(dmElement) + 4) % 5], outputElement = elementCycle[(elementCycle.indexOf(dmElement) + 1) % 5];
                 const wealthElement = elementCycle[(elementCycle.indexOf(dmElement) + 2) % 5], powerElement = elementCycle[(elementCycle.indexOf(dmElement) + 3) % 5];
                 let favorable, unfavorable;
                 if (dayMasterStrengthStatus.includes('Kuat') || dayMasterStrengthStatus.includes('Seimbang') || specialChartType.includes('旺格')) {
                    favorable = [outputElement, wealthElement, powerElement]; unfavorable = [dmElement, resourceElement];
                 } else { 
                    favorable = [dmElement, resourceElement]; unfavorable = [outputElement, wealthElement, powerElement];
                 }
                summaryHtml = `<h3 class="font-semibold text-white mb-3">Ringkasan</h3><div class="text-sm space-y-2">`;
                if (specialChartType) { summaryHtml += `<p>Tipe Bagan: <span class="font-bold text-lg text-purple-400">${specialChartType}</span></p>`; }
                summaryHtml += `<p>Kekuatan Day Master: <span class="font-bold text-lg ${dayMasterStrengthStatus.includes('Kuat') ? 'text-green-400' : (dayMasterStrengthStatus.includes('Lemah') ? 'text-red-400' : 'text-yellow-400')}">${dayMasterStrengthStatus}</span></p><p>Elemen Menguntungkan: <span class="font-semibold text-green-400">${favorable.join(', ')}</span></p><p>Elemen Tidak Menguntungkan: <span class="font-semibold text-red-400">${unfavorable.join(', ')}</span></p></div>`;
            }
            elementStrengthDiv.innerHTML = `<div class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6"><h2 class="text-xl font-bold text-white mb-4">Analisis Kekuatan Elemen</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6"><div><h3 class="font-semibold text-white mb-3">Distribusi Elemen</h3>${chartHtml}</div><div>${summaryHtml}</div></div></div>`;
        }
        function display10GodsDistribution(tenGodsDistributionResults) {
            let godsHtml = tenGodsDistributionResults.map(god => `<div class="flex items-center mb-2"><div class="w-32 text-sm text-gray-300">${god.name}</div><div class="flex-1 bg-gray-700 rounded-full h-5"><div class="chart-bar bg-blue-500 h-5 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: ${Math.min(100, god.score)}%">${god.score}</div></div></div>`).join('');
            tenGodsDistributionDiv.innerHTML = `<div class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6"><h2 class="text-xl font-bold text-white mb-4">Peta Distribusi 10 Gods</h2><p class="text-gray-400 text-sm mb-4">Menunjukkan pengaruh relatif setiap 10 Gods. Semakin tinggi skor, semakin dominan pengaruhnya.</p>${godsHtml}</div>`;
        }
        function displayMingGuaAndBaZhai(mingGuaResult, baZhaiResult) {
            let baZhaiHtml = '';
            if (baZhaiResult) {
                baZhaiHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <h3 class="font-semibold text-white mb-3">Arah Menguntungkan (Auspicious)</h3>
                            <ul class="list-disc list-inside text-sm text-gray-400 space-y-2">
                                <li><strong>Sheng Qi (生氣) - ${baZhaiResult.best.ShengQi}:</strong> Kemakmuran, Vitalitas, Kesuksesan.</li>
                                <li><strong>Tian Yi (天醫) - ${baZhaiResult.best.TianYi}:</strong> Kesehatan, Penyembuhan, Bantuan.</li>
                                <li><strong>Yan Nian (延年) - ${baZhaiResult.best.YanNian}:</strong> Hubungan Harmonis, Jaringan.</li>
                                <li><strong>Fu Wei (伏位) - ${baZhaiResult.best.FuWei}:</strong> Stabilitas, Ketenangan, Pertumbuhan Pribadi.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-semibold text-white mb-3">Arah Tidak Menguntungkan (Inauspicious)</h3>
                            <ul class="list-disc list-inside text-sm text-gray-400 space-y-2">
                                <li><strong>Huo Hai (禍害) - ${baZhaiResult.worst.HuoHai}:</strong> Hambatan, Kesialan Kecil, Perselisihan.</li>
                                <li><strong>Liu Sha (六煞) - ${baZhaiResult.worst.LiuSha}:</strong> Masalah Hukum, Skandal, Hubungan Buruk.</li>
                                <li><strong>Wu Gui (五鬼) - ${baZhaiResult.worst.WuGui}:</strong> Pengkhianatan, Gosip, Pikiran Negatif.</li>
                                <li><strong>Jue Ming (絕命) - ${baZhaiResult.worst.JueMing}:</strong> Kerugian Total, Bencana, Penyakit Parah.</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            mingGuaBaZhaiResultDiv.innerHTML = `<div class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6"><h2 class="text-xl font-bold text-white mb-4">Ming Gua & Ba Zhai</h2><div class="text-sm space-y-2 mb-4"><p>Ming Gua Anda: <span class="font-bold text-lg text-blue-400">${mingGuaResult}</span> | Kelompok Rumah: <span class="font-bold text-lg text-blue-400">${baZhaiResult ? baZhaiResult.group : 'N/A'} Group</span></p></div>${baZhaiHtml}</div>`;
        }

        // --- FUNGSI INTERAKTIF ---
        function detectAndDisplayDynamicInteractions(natalPillars, dayun, liunian) {
            const events = [];
            const natalBranches = natalPillars.map(p => p.branch.char);
            const guestPillars = [dayun, liunian].filter(Boolean); // Filter out null/undefined guests

            guestPillars.forEach(guest => {
                const guestBranch = guest.branch.char;

                // 1. Cek Clash
                natalPillars.forEach(natalPillar => {
                    if (interactionData.clash[guestBranch] === natalPillar.branch.char) {
                        events.push({
                            icon: '⚔️',
                            title: 'Benturan (Clash) Terjadi',
                            color: 'text-red-400',
                            message: `Pilar ${guest.title} <strong>${guestBranch} (${guest.branch.animal})</strong> berbenturan dengan Pilar ${natalPillar.title} <strong>${natalPillar.branch.char} (${natalPillar.branch.animal})</strong>.`
                        });
                    }
                });

                // 2. Cek Six Harmony
                natalPillars.forEach(natalPillar => {
                    interactionData.sixHarmony.forEach(harmony => {
                        if ((harmony.combo[0] === guestBranch && harmony.combo[1] === natalPillar.branch.char) || (harmony.combo[1] === guestBranch && harmony.combo[0] === natalPillar.branch.char)) {
                            events.push({
                                icon: harmony.icon,
                                title: `Kombinasi 6 Harmoni (${harmony.element}) Aktif`,
                                color: 'text-green-400',
                                message: `Pilar ${guest.title} <strong>${guestBranch} (${guest.branch.animal})</strong> bergabung dengan Pilar ${natalPillar.title} <strong>${natalPillar.branch.char} (${natalPillar.branch.animal})</strong>.`
                            });
                        }
                    });
                });

                // 3. Cek Three Harmony Completion
                interactionData.threeHarmony.forEach(harmony => {
                    if (harmony.combo.includes(guestBranch)) {
                        const needed = harmony.combo.filter(b => b !== guestBranch);
                        if (needed.every(b => natalBranches.includes(b))) {
                            events.push({
                                icon: harmony.icon,
                                title: `Kombinasi 3 Harmoni (${harmony.element}) Aktif`,
                                color: 'text-green-400',
                                message: `Pilar ${guest.title} <strong>${guestBranch} (${guest.branch.animal})</strong> melengkapi <strong>${needed.join(' & ')}</strong> di bagan lahir.`
                            });
                        }
                    }
                });
            });

            if (events.length === 0) {
                dynamicInteractionPanel.innerHTML = '';
                return;
            }

            let eventsHtml = events.map(event => `
                <div class="flex items-start">
                    <span class="text-xl mr-3 mt-1">${event.icon}</span>
                    <div>
                        <p class="font-semibold ${event.color}">${event.title}</p>
                        <p class="text-sm text-gray-400">${event.message}</p>
                    </div>
                </div>
            `).join('<hr class="border-gray-700 my-3">');

            dynamicInteractionPanel.innerHTML = `
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 max-w-4xl mx-auto">
                    <h3 class="font-bold text-lg text-white mb-3">Interaksi Kunci Terdeteksi:</h3>
                    <div class="space-y-3">${eventsHtml}</div>
                </div>`;
        }
        function handleDayunClick(event) {
            if (!natalChartData) return;
            const pillarCard = event.target.closest('.dayun-pillar-card');
            if (!pillarCard) return;

            document.querySelectorAll('.dayun-pillar-card').forEach(card => card.classList.remove('selected-dayun-analysis'));
            annualPillarDiv.innerHTML = ''; 
            selectedLiunian = null;

            const stemIndex = parseInt(pillarCard.dataset.stemIndex);
            const branchIndex = parseInt(pillarCard.dataset.branchIndex);
            const ageRange = pillarCard.dataset.ageRange;

            if (selectedDayun && selectedDayun.stem.index === stemIndex && selectedDayun.branch.index === branchIndex) {
                resetToNatalAnalysis();
                return;
            }
            
            pillarCard.classList.add('selected-dayun-analysis');
            selectedDayun = { title: 'Dayun', stem: heavenlyStems[stemIndex], branch: earthlyBranches[branchIndex], branchIndex: branchIndex, ageRange: ageRange };

            const combinedPillars = [...natalChartData.pillars, selectedDayun];
            runFullAnalysis(combinedPillars, natalChartData.dayMaster, natalChartData.isHourUnknown, natalChartData.gender, `Analisis Sementara: Bagan Kelahiran + Siklus Keberuntungan (Usia ${ageRange})`);
            displayAnnualPillars(ageRange);
        }
        function handleLiunianClick(event) {
            if (!natalChartData || !selectedDayun) return;
            const pillarCard = event.target.closest('.liunian-pillar-card');
            if (!pillarCard) return;

            document.querySelectorAll('.liunian-pillar-card').forEach(card => card.classList.remove('selected-liunian-analysis'));

            const year = parseInt(pillarCard.dataset.year);
            const stemIndex = parseInt(pillarCard.dataset.stemIndex);
            const branchIndex = parseInt(pillarCard.dataset.branchIndex);

            if (selectedLiunian && selectedLiunian.year === year) {
                selectedLiunian = null;
                const combinedPillars = [...natalChartData.pillars, selectedDayun];
                runFullAnalysis(combinedPillars, natalChartData.dayMaster, natalChartData.isHourUnknown, natalChartData.gender, `Analisis Sementara: Bagan Kelahiran + Siklus Keberuntungan (Usia ${selectedDayun.ageRange})`);
                return;
            }

            pillarCard.classList.add('selected-liunian-analysis');
            selectedLiunian = { title: 'Liunian', year: year, stem: heavenlyStems[stemIndex], branch: earthlyBranches[branchIndex], branchIndex: branchIndex };

            const combinedPillars = [...natalChartData.pillars, selectedDayun, selectedLiunian];
            runFullAnalysis(combinedPillars, natalChartData.dayMaster, natalChartData.isHourUnknown, natalChartData.gender, `Analisis Spesifik: Natal + Dayun ${selectedDayun.ageRange} + Tahun ${year}`);
        }
        function resetToNatalAnalysis() {
            if (!natalChartData) return;
            selectedDayun = null;
            selectedLiunian = null;
            document.querySelectorAll('.pillar-card').forEach(card => card.classList.remove('selected-dayun-analysis', 'selected-liunian-analysis'));
            annualPillarDiv.innerHTML = '';
            runFullAnalysis(natalChartData.pillars, natalChartData.dayMaster, natalChartData.isHourUnknown, natalChartData.gender);
        }

        // --- FUNGSI DASBOR ASPEK KEHIDUPAN ---
        function calculateLifeAspects(tenGodsScores, favorable, unfavorable, gender, dayMaster) {
            const scores = {};
            tenGodsScores.forEach(god => { scores[god.name] = god.score; });

            const getScore = (godNames, isFavorableCheck = true) => {
                let totalScore = 0;
                godNames.forEach(name => {
                    const godScore = scores[name] || 0;
                    if (isFavorableCheck) {
                        const godElement = tenGods[dayMaster.element][elementCycle.find(e => tenGods[dayMaster.element][e].same === name.replace(/ /g, '').slice(0,2) || tenGods[dayMaster.element][e].diff === name.replace(/ /g, '').slice(0,2))]?.same === name.replace(/ /g, '').slice(0,2) ? 
                                           elementCycle.find(e => tenGods[dayMaster.element][e].same === name.replace(/ /g, '').slice(0,2)) :
                                           elementCycle.find(e => tenGods[dayMaster.element][e].diff === name.replace(/ /g, '').slice(0,2));
                        if (favorable.includes(godElement)) {
                            totalScore += godScore * 1.5; // Bonus for favorable
                        } else if (unfavorable.includes(godElement)) {
                            totalScore += godScore * 0.5; // Penalty for unfavorable
                        } else {
                            totalScore += godScore;
                        }
                    } else {
                        totalScore += godScore;
                    }
                });
                return totalScore;
            };

            const aspects = {
                'Karir': getScore(['Direct Officer', '7 Killings']),
                'Finansial': getScore(['Direct Wealth', 'Indirect Wealth']),
                'Hubungan': (gender === 'Pria') ? getScore(['Direct Wealth', 'Indirect Wealth']) : getScore(['Direct Officer', '7 Killings']),
                'Kesehatan': getScore(['Direct Resource', 'Indirect Resource']),
                'Sosial': getScore(['Friend', 'Rob Wealth']),
                'Ekspresi': getScore(['Eating God', 'Hurting Officer']),
            };

            // Normalize scores to be around 0-100
            const maxScore = Math.max(...Object.values(aspects), 50); // Use 50 as a minimum max to avoid tiny scores looking huge
            for (const aspect in aspects) {
                aspects[aspect] = Math.min(100, Math.round((aspects[aspect] / maxScore) * 100));
            }
            return aspects;
        }

        function displayLifeAspectsDashboard(natalScores, currentScores) {
            if (!natalScores || !currentScores) {
                lifeAspectsDashboard.innerHTML = '';
                return;
            }

            let dashboardHtml = '<div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center">';
            const aspects = ['Karir', 'Finansial', 'Hubungan', 'Kesehatan', 'Sosial', 'Ekspresi'];

            aspects.forEach(aspect => {
                const natalScore = natalScores[aspect];
                const currentScore = currentScores[aspect];
                const diff = currentScore - natalScore;
                let diffHtml = '';
                if (natalScores !== currentScores) {
                    if (diff > 0) {
                        diffHtml = `<span class="text-xs text-green-400">↑ ${diff}%</span>`;
                    } else if (diff < 0) {
                        diffHtml = `<span class="text-xs text-red-400">↓ ${Math.abs(diff)}%</span>`;
                    } else {
                        diffHtml = `<span class="text-xs text-gray-500">~ 0%</span>`;
                    }
                }

                dashboardHtml += `
                    <div>
                        <div class="aspect-bar-bg mx-auto w-16">
                            <div class="aspect-bar bg-yellow-700" style="height: ${natalScore}%" title="Potensi Natal: ${natalScore}%"></div>
                            <div class="aspect-bar bg-amber-400 ml-1" style="height: ${currentScore}%" title="Potensi Periode Ini: ${currentScore}%"></div>
                        </div>
                        <p class="text-sm font-semibold mt-2">${aspect}</p>
                        <div class="h-4">${diffHtml}</div>
                    </div>
                `;
            });
            dashboardHtml += '</div>';

            lifeAspectsDashboard.innerHTML = `
                <div class="bg-gray-800 shadow-2xl rounded-xl max-w-4xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Dasbor Aspek Kehidupan</h2>
                        <div class="flex items-center text-sm">
                            <span class="w-4 h-4 rounded bg-yellow-700 mr-2"></span><span class="mr-4">Natal</span>
                            <span class="w-4 h-4 rounded bg-amber-400 mr-2"></span><span>Periode Ini</span>
                        </div>
                    </div>
                    ${dashboardHtml}
                </div>`;
        }


        // --- INISIALISASI & EVENT LISTENERS ---
        populateDateSelectors();
        populateTimeSelectors(); 
        calculateBtn.addEventListener('click', calculateBaziChart);
        resetBtn.addEventListener('click', resetForm);
        birthYearInput.addEventListener('change', populateDaySelector);
        birthMonthInput.addEventListener('change', populateDaySelector);
        unknownHourCheckbox.addEventListener('change', () => {
            timeContainer.classList.toggle('opacity-50', unknownHourCheckbox.checked);
            timeContainer.classList.toggle('pointer-events-none', unknownHourCheckbox.checked);
        });
        luckPillarDiv.addEventListener('click', handleDayunClick);
        annualPillarDiv.addEventListener('click', handleLiunianClick);
    });
    </script>
</body>
</html>
